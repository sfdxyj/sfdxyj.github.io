<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.html"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="夏远建的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="夏远建的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="夏远建">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>夏远建的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">夏远建的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">不积硅步，无以至千里；不积小流，无以成江海</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/26/2024-12-26-%E4%BD%BF%E7%94%A8JNA-%E5%92%8C-JNI-%E6%8A%80%E6%9C%AF%E8%B0%83%E7%94%A8c++%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/26/2024-12-26-%E4%BD%BF%E7%94%A8JNA-%E5%92%8C-JNI-%E6%8A%80%E6%9C%AF%E8%B0%83%E7%94%A8c++%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">2024-12-26-使用JNA 和 JNI 技术调用c++代码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-12-26 17:46:27 / 修改时间：21:36:14" itemprop="dateCreated datePublished" datetime="2024-12-26T17:46:27+08:00">2024-12-26</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/12/26/2024-12-26-%E4%BD%BF%E7%94%A8JNA-%E5%92%8C-JNI-%E6%8A%80%E6%9C%AF%E8%B0%83%E7%94%A8c++%E4%BB%A3%E7%A0%81/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/12/26/2024-12-26-%E4%BD%BF%E7%94%A8JNA-%E5%92%8C-JNI-%E6%8A%80%E6%9C%AF%E8%B0%83%E7%94%A8c++%E4%BB%A3%E7%A0%81/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用-jnd-调用-c-代码"><a href="#使用-jnd-调用-c-代码" class="headerlink" title="使用 jnd 调用 c++ 代码"></a>使用 jnd 调用 c++ 代码</h1><ol>
<li>视频底座需要对接海康和大华的摄像头。对摄像头进行录屏和快进等操作。海康和大华提供的 sdk 中代码都是 c++编写的。使用 JNA 技术去调用 sdk 提供的接口方法。 实现对摄像头的操作。<ol>
<li>导入 jna， 导入对应的 sdk</li>
</ol>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.iwhalecloud.camera&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jna&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;system&lt;/scope&gt;</span><br><span class="line">    &lt;systemPath&gt;$&#123;project.basedir&#125;/libs/jna.jar&lt;/systemPath&gt;</span><br><span class="line">    &lt;!--win本地开发使用版本--&gt;</span><br><span class="line">    &lt;!--&lt;systemPath&gt;$&#123;project.basedir&#125;/libs/cameraSDKWin.jar&lt;/systemPath&gt;--&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>定义 java 接口映射 sdk 摄像头操作的方法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> HCNetSDK INSTANCE = (HCNetSDK) Native.loadLibrary(&quot;hcnetsdk&quot;, HCNetSDK.class);</span><br><span class="line"></span><br><span class="line"> interface FMSGCallBack_V31 extends Callback &#123;</span><br><span class="line">     boolean invoke(int lCommand, NET_DVR_ALARMER pAlarmer, Pointer pAlarmInfo, int dwBufLen, Pointer pUser);</span><br><span class="line"> &#125;</span><br><span class="line">// 2005-09-15</span><br><span class="line"> boolean NET_DVR_CaptureJPEGPicture(NativeLong lUserID, NativeLong lChannel, NET_DVR_JPEGPARA lpJpegPara,</span><br><span class="line">                                    String sPicFileName);</span><br><span class="line"></span><br><span class="line"> // JPEG抓图到内存</span><br><span class="line"> // boolean NET_DVR_CaptureJPEGPicture_NEW(NativeLong lUserID, NativeLong lChannel, NET_DVR_JPEGPARA lpJpegPara,</span><br><span class="line"> // String sJpegPicBuffer, int dwPicSize, IntByReference lpSizeReturned);</span><br><span class="line"> boolean NET_DVR_CaptureJPEGPicture_NEW(NativeLong lUserID, NativeLong lChannel, NET_DVR_JPEGPARA lpJpegPara,</span><br><span class="line">                                        ByteBuffer jpegBuffer, int dwPicSize, IntByReference lpSizeReturned);</span><br><span class="line"></span><br><span class="line"> int NET_DVR_GetLastError();</span><br><span class="line"></span><br><span class="line"> NativeLong NET_DVR_Login_V30(String sDVRIP, short wDVRPort, String sUserName, String sPassword,</span><br><span class="line">                              NET_DVR_DEVICEINFO_V30 lpDeviceInfo);</span><br><span class="line"></span><br><span class="line"> boolean NET_DVR_GetDVRWorkState_V30(NativeLong lUserID, NET_DVR_WORKSTATE_V30 lpWorkState);</span><br><span class="line"></span><br><span class="line"> boolean NET_DVR_PTZControlWithSpeed(NativeLong lRealHandle, int dwPTZCommand, int dwStop, int dwSpeed);</span><br><span class="line"></span><br><span class="line"> boolean NET_DVR_PTZControl_Other(NativeLong lUserID, NativeLong lChannel, int dwPTZCommand, int dwStop);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意 c++中指针类型在 java 中需要用 Pointer 类型</p>
<ol start="3">
<li>调用具体的方法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> hcNetSDK.NET_DVR_SetReconnect(5000, true);</span><br><span class="line">HCNetSDK.NET_DVR_DEVICEINFO_V30 strDeviceInfo = new HCNetSDK.NET_DVR_DEVICEINFO_V30();</span><br><span class="line">NativeLong loginHandle = hcNetSDK.NET_DVR_Login_V30(request.getStrIp(), (short) request.getPort(),</span><br><span class="line">        request.getStrUser(), request.getStrPas(), strDeviceInfo);</span><br><span class="line">if (loginHandle.intValue() &lt; 0) &#123;</span><br><span class="line">    int error = hcNetSDK.NET_DVR_GetLastError();</span><br><span class="line">    log.error(&quot;登录错误 NET_DVR_Login_V30 errorCode:&#123;&#125;, 错误描述:&#123;&#125;, traceId:&#123;&#125;&quot;, HkErrorCode.getErrorCode(error),</span><br><span class="line">            HkErrorCode.getErrorDesc(error), request.getTraceId());</span><br><span class="line">    return new NativeLong(-1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用-jni-调用-c-代码"><a href="#使用-jni-调用-c-代码" class="headerlink" title="使用 jni 调用 c++ 代码"></a>使用 jni 调用 c++ 代码</h3><ol>
<li>摄像头需要判断画面有没有变化，需要调用移动侦测算法。判断摄像头画面是否有变化。java 实现性能比较低，使用 c++ 代码实现，然后通过 jni 调用</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private static final MoveCheck instance = new MoveCheck();</span><br><span class="line">   static &#123;</span><br><span class="line">       init();</span><br><span class="line">   &#125;</span><br><span class="line">   public static MoveCheck getInstance() &#123;</span><br><span class="line">       return instance;</span><br><span class="line">   &#125;</span><br><span class="line">   private MoveCheck() &#123;</span><br><span class="line">   &#125;</span><br><span class="line">   public static void init() &#123;</span><br><span class="line">       JniLibraryLoadUtil.load(&quot;MoveCheck&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">   /**</span><br><span class="line">    * @param imag1       当前图片</span><br><span class="line">    * @param imag2       上一张图片</span><br><span class="line">    * @param simi_thresh 阈值</span><br><span class="line">    * @param rms         变化值，取值0-255</span><br><span class="line">    * @return 移动侦测状态: 1：异常,存在变化 0：正常，未变化</span><br><span class="line">    */</span><br><span class="line">   public native int check(byte[] imag1, byte[] imag2, int simi_thresh, FloatHolder rms);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String jnaLibPath = System.getProperty(JNA_PATH_PROPERTY_NAME);</span><br><span class="line"> log.info(&quot;当前 jna.library.path动态库目录： &#123;&#125;&quot;, jnaLibPath);</span><br><span class="line"> System.setProperty(&quot;jna.debug_load&quot;, &quot;true&quot;);</span><br><span class="line"></span><br><span class="line"> if (!DEFAULT_LIB_PATH.equals(jnaLibPath)) &#123;</span><br><span class="line">     log.info(&quot;开始设置-动态库目录： &#123;&#125;&quot;, DEFAULT_LIB_PATH);</span><br><span class="line">     System.setProperty(JNA_PATH_PROPERTY_NAME, DEFAULT_LIB_PATH);</span><br><span class="line">     log.info(&quot;设置完成后-动态库目录：&#123;&#125;&quot;, System.getProperty(JNA_PATH_PROPERTY_NAME));</span><br><span class="line"> &#125;</span><br><span class="line"> //System.loadLibrary(libName);</span><br><span class="line"> System.load(StrUtil.format(&quot;&#123;&#125;/lib&#123;&#125;.so&quot;, DEFAULT_LIB_PATH, libName));</span><br><span class="line"> log.info(&quot;&#123;&#125;加载完成&quot;, libName);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="JNI-调用与-JNA-的区别"><a href="#JNI-调用与-JNA-的区别" class="headerlink" title="JNI 调用与 JNA 的区别"></a>JNI 调用与 JNA 的区别</h3><p>在 Java 中，JNI（Java Native Interface）和 JNA（Java Native Access）都是用于调用本地代码的技术，但它们在使用方式和特性上有显著区别。以下是它们的主要区别：</p>
<ul>
<li><p><strong>复杂性</strong>:</p>
<ul>
<li>JNI 是一种较低级别的接口，需要编写和维护本地代码（通常是 C 或 C++），并且需要通过 Java 和本地代码之间的桥接来进行调用。</li>
<li>需要编写头文件并进行手动编译，步骤较为复杂。</li>
</ul>
</li>
<li><p><strong>性能</strong>:</p>
<ul>
<li>通常比 JNA 更高效，因为它直接与 JVM 交互，没有额外的抽象层。</li>
</ul>
</li>
<li><p><strong>控制</strong>:</p>
<ul>
<li>提供对本地系统的更大控制力度，可以进行复杂的内存操作和其他系统级操作。</li>
</ul>
</li>
<li><p><strong>使用场景</strong>:</p>
<ul>
<li>适合需要高性能和复杂操作的场景，比如游戏开发、图形处理等。</li>
</ul>
</li>
</ul>
<h3 id="JNA（Java-Native-Access）"><a href="#JNA（Java-Native-Access）" class="headerlink" title="JNA（Java Native Access）"></a>JNA（Java Native Access）</h3><ul>
<li><p><strong>复杂性</strong>:</p>
<ul>
<li>JNA 是一种更高级别的接口，允许直接在 Java 中调用本地库函数，无需编写本地代码。</li>
<li>只需要定义接口，JNA 会自动处理库加载和方法调用。</li>
</ul>
</li>
<li><p><strong>性能</strong>:</p>
<ul>
<li>由于增加了一层抽象，性能可能稍逊于 JNI，但对于大多数应用程序来说是足够的。</li>
</ul>
</li>
<li><p><strong>控制</strong>:</p>
<ul>
<li>提供的控制力度较小，主要用于调用现有的本地库函数。</li>
</ul>
</li>
<li><p><strong>使用场景</strong>:</p>
<ul>
<li>适合需要快速集成和开发的场景，特别是当只需调用现有的本地库时。</li>
</ul>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>JNI</strong> 提供了更高的性能和控制，但需要更多的开发工作和复杂的配置。</li>
<li><strong>JNA</strong> 提供了更简便的开发体验，适合快速开发和集成现有库，但可能在性能上稍逊。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/18/ES6,%20ES10,ES11%20%E7%AD%89%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/18/ES6,%20ES10,ES11%20%E7%AD%89%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">ES6, ES10,ES11 等高级语法学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-12-18 11:07:44 / 修改时间：16:13:38" itemprop="dateCreated datePublished" datetime="2024-12-18T11:07:44+08:00">2024-12-18</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/12/18/ES6,%20ES10,ES11%20%E7%AD%89%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/12/18/ES6,%20ES10,ES11%20%E7%AD%89%E9%AB%98%E7%BA%A7%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-块级作用域（let-和-const）"><a href="#1-块级作用域（let-和-const）" class="headerlink" title="1. 块级作用域（let 和 const）"></a>1. 块级作用域（<code>let</code> 和 <code>const</code>）</h2><ul>
<li>**<code>let</code>**：用于声明局部变量，有块级作用域。</li>
<li>**<code>const</code>**：用于声明常量，一旦赋值不能重新赋值。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> x = <span class="number">20</span>; <span class="comment">// 块级作用域</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(x); <span class="comment">// 20</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x); <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> y = <span class="number">30</span>;</span><br><span class="line"><span class="comment">// y = 40; // 会抛出错误</span></span><br></pre></td></tr></table></figure>

<h2 id="2-箭头函数"><a href="#2-箭头函数" class="headerlink" title="2. 箭头函数"></a>2. 箭头函数</h2><p>简化函数定义，尤其适用于回调函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params">a, b</span>) =&gt; a + b;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">2</span>, <span class="number">3</span>)); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<h2 id="3-模板字符串"><a href="#3-模板字符串" class="headerlink" title="3. 模板字符串"></a>3. 模板字符串</h2><p>支持多行字符串和内嵌表达式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&quot;World&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello, <span class="subst">$&#123;name&#125;</span>!`</span>); <span class="comment">// Hello, World!</span></span><br></pre></td></tr></table></figure>

<h2 id="4-解构赋值"><a href="#4-解构赋值" class="headerlink" title="4. 解构赋值"></a>4. 解构赋值</h2><p>从数组或对象中提取数据。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">const</span> [a, b] = array;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a, b); <span class="comment">// 1 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">x</span>: <span class="number">10</span>, <span class="attr">y</span>: <span class="number">20</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> &#123; x, y &#125; = obj;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x, y); <span class="comment">// 10 20</span></span><br></pre></td></tr></table></figure>

<h2 id="5-默认参数"><a href="#5-默认参数" class="headerlink" title="5. 默认参数"></a>5. 默认参数</h2><p>为函数参数设置默认值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">multiply</span>(<span class="params">a, b = <span class="number">1</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">multiply</span>(<span class="number">5</span>)); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<h2 id="6-展开运算符"><a href="#6-展开运算符" class="headerlink" title="6. 展开运算符"></a>6. 展开运算符</h2><p>用于数组和对象的展开。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr1 = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">const</span> arr2 = [<span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">const</span> combined = [...arr1, ...arr2];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(combined); <span class="comment">// [1, 2, 3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj1 = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> obj2 = &#123; <span class="attr">b</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> merged = &#123; ...obj1, ...obj2 &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(merged); <span class="comment">// &#123; a: 1, b: 2 &#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="7-类和继承"><a href="#7-类和继承" class="headerlink" title="7. 类和继承"></a>7. 类和继承</h2><p>用于创建对象和继承。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> makes a noise.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Animal</span> &#123;</span><br><span class="line">  <span class="title function_">speak</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> barks.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dog = <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;Rex&quot;</span>);</span><br><span class="line">dog.<span class="title function_">speak</span>(); <span class="comment">// Rex barks.</span></span><br></pre></td></tr></table></figure>

<h2 id="8-模块导入和导出"><a href="#8-模块导入和导出" class="headerlink" title="8. 模块导入和导出"></a>8. 模块导入和导出</h2><p>用于模块化代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// math.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> pi = <span class="number">3.1415</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">square</span>(<span class="params">x</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; pi, square &#125; <span class="keyword">from</span> <span class="string">&quot;./math&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pi); <span class="comment">// 3.1415</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">square</span>(<span class="number">2</span>)); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>

<h2 id="9-Promise-对象"><a href="#9-Promise-对象" class="headerlink" title="9. Promise 对象"></a>9. Promise 对象</h2><p>用于异步操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(<span class="string">&quot;Success!&quot;</span>), <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">promise.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(result)); <span class="comment">// 1秒后输出 &quot;Success!&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="10-Symbol"><a href="#10-Symbol" class="headerlink" title="10. Symbol"></a>10. Symbol</h2><p>创建唯一标识符。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sym1 = <span class="title class_">Symbol</span>(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> sym2 = <span class="title class_">Symbol</span>(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sym1 === sym2); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h2 id="11-可选链操作符"><a href="#11-可选链操作符" class="headerlink" title="11. 可选链操作符 ?."></a>11. 可选链操作符 ?.</h2><p>es11 语法用于安全地访问对象的嵌套属性，而不必担心中途遇到 null 或 undefined 导致错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">  <span class="attr">address</span>: &#123;</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&quot;New York&quot;</span>,</span><br><span class="line">    <span class="attr">zip</span>: <span class="string">&quot;10001&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用可选链操作符</span></span><br><span class="line"><span class="keyword">const</span> city = user?.<span class="property">address</span>?.<span class="property">city</span>; <span class="comment">// &#x27;New York&#x27;</span></span><br><span class="line"><span class="keyword">const</span> street = user?.<span class="property">address</span>?.<span class="property">street</span>; <span class="comment">// undefined, 而不是抛出错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果没有可选链操作符，可能需要这样做</span></span><br><span class="line"><span class="keyword">const</span> cityWithoutOptionalChaining = user &amp;&amp; user.<span class="property">address</span> &amp;&amp; user.<span class="property">address</span>.<span class="property">city</span>;</span><br></pre></td></tr></table></figure>

<h2 id="12-Array-from"><a href="#12-Array-from" class="headerlink" title="12. Array.from"></a>12. Array.from</h2><p><code>Array.from</code> 是一个用于从类数组对象或可迭代对象创建新数组的静态方法。它在 ES6（ECMAScript 2015）中被引入，提供了一种从各种对象中创建数组的简便方法。</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Array</span>.<span class="title function_">from</span>(arrayLike[, mapFn[, thisArg]])</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>arrayLike</code></strong>: 想要转换为数组的类数组对象或可迭代对象。</li>
<li>**<code>mapFn</code>**（可选）: 一个映射函数，用于对每个元素进行处理后再放入数组。</li>
<li>**<code>thisArg</code>**（可选）: 执行 <code>mapFn</code> 函数时 <code>this</code> 的值。</li>
</ul>
<h2 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h2><h3 id="将类数组对象转换为数组"><a href="#将类数组对象转换为数组" class="headerlink" title="将类数组对象转换为数组"></a>将类数组对象转换为数组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">example</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">arguments</span>); <span class="comment">// 类数组对象</span></span><br><span class="line">  <span class="keyword">const</span> argsArray = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(argsArray); <span class="comment">// [1, 2, 3]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">example</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h3 id="将字符串转换为数组"><a href="#将字符串转换为数组" class="headerlink" title="将字符串转换为数组"></a>将字符串转换为数组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> strArray = <span class="title class_">Array</span>.<span class="title function_">from</span>(str);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(strArray); <span class="comment">// [&#x27;h&#x27;, &#x27;e&#x27;, &#x27;l&#x27;, &#x27;l&#x27;, &#x27;o&#x27;]</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-mapFn"><a href="#使用-mapFn" class="headerlink" title="使用 mapFn"></a>使用 <code>mapFn</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">const</span> doubled = <span class="title class_">Array</span>.<span class="title function_">from</span>(numbers, <span class="function">(<span class="params">x</span>) =&gt;</span> x * <span class="number">2</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(doubled); <span class="comment">// [2, 4, 6]</span></span><br></pre></td></tr></table></figure>

<h3 id="从-Set-创建数组"><a href="#从-Set-创建数组" class="headerlink" title="从 Set 创建数组"></a>从 Set 创建数组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mySet = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">const</span> setArray = <span class="title class_">Array</span>.<span class="title function_">from</span>(mySet);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(setArray); <span class="comment">// [1, 2, 3]</span></span><br></pre></td></tr></table></figure>

<h2 id="12-Array-prototype-flatMap"><a href="#12-Array-prototype-flatMap" class="headerlink" title="12. Array.prototype.flatMap"></a>12. <code>Array.prototype.flatMap</code></h2><p><code>flatMap</code> 方法是 JavaScript 中数组的一个实例方法，它结合了 <code>map</code> 和 <code>flat</code> 方法的功能。它首先对数组中的每个元素应用一个映射函数，然后将结果展平为一个新数组。这个方法在 ES2019（ES10）中被引入。</p>
<h2 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arr.<span class="title function_">flatMap</span>(callback[, thisArg])</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>callback</code></strong>: 一个函数，用于生成新数组中的每个元素。它接收三个参数：<ul>
<li><code>currentValue</code>: 当前处理的元素。</li>
<li><code>index</code>（可选）: 当前元素的索引。</li>
<li><code>array</code>（可选）: 调用 <code>flatMap</code> 的数组。</li>
</ul>
</li>
<li>**<code>thisArg</code>**（可选）: 执行 <code>callback</code> 函数时 <code>this</code> 的值。</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li><strong>映射和展平</strong>: <code>flatMap</code> 方法执行 <code>map</code> 操作后，自动对结果进行深度为 1 的展平。</li>
<li><strong>简化代码</strong>: 在需要同时进行映射和展平操作时，<code>flatMap</code> 提供了一种更简洁的方式。</li>
</ul>
<h2 id="用法示例-1"><a href="#用法示例-1" class="headerlink" title="用法示例"></a>用法示例</h2><h3 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 flatMap 将每个元素映射为一个数组，并展平结果</span></span><br><span class="line"><span class="keyword">const</span> result = arr.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> [x, x * <span class="number">2</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// [1, 2, 2, 4, 3, 6, 4, 8]</span></span><br></pre></td></tr></table></figure>

<h3 id="过滤和展平"><a href="#过滤和展平" class="headerlink" title="过滤和展平"></a>过滤和展平</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> words = [<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 flatMap 进行过滤和展平</span></span><br><span class="line"><span class="keyword">const</span> letters = words.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">word</span>) =&gt;</span> word.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(letters); <span class="comment">// [&#x27;h&#x27;, &#x27;e&#x27;, &#x27;l&#x27;, &#x27;l&#x27;, &#x27;o&#x27;, &#x27;w&#x27;, &#x27;o&#x27;, &#x27;r&#x27;, &#x27;l&#x27;, &#x27;d&#x27;]</span></span><br></pre></td></tr></table></figure>

<h3 id="与-map-和-flat-的对比"><a href="#与-map-和-flat-的对比" class="headerlink" title="与 map 和 flat 的对比"></a>与 <code>map</code> 和 <code>flat</code> 的对比</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 map 和 flat 的组合</span></span><br><span class="line"><span class="keyword">const</span> mapped = arr.<span class="title function_">map</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> [x, x * <span class="number">2</span>]);</span><br><span class="line"><span class="keyword">const</span> flatMapped = mapped.<span class="title function_">flat</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(flatMapped); <span class="comment">// [1, 2, 2, 4, 3, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 flatMap 等效于上面的组合</span></span><br><span class="line"><span class="keyword">const</span> result = arr.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> [x, x * <span class="number">2</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// [1, 2, 2, 4, 3, 6]</span></span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li><code>flatMap</code> 仅会展平一层深度。如果需要展平更深的嵌套结构，需要结合其他方法，如 <code>reduce</code> 或多次使用 <code>flat</code>。</li>
</ul>
<h2 id="用例-1-前端表格需要实现多表头和合并行的需求-使用-flatMap-展平元素-使用-Array-from-创造新数组"><a href="#用例-1-前端表格需要实现多表头和合并行的需求-使用-flatMap-展平元素-使用-Array-from-创造新数组" class="headerlink" title="用例 1 :前端表格需要实现多表头和合并行的需求,使用 flatMap 展平元素,使用 Array.from 创造新数组."></a>用例 1 :前端表格需要实现多表头和合并行的需求,使用 flatMap 展平元素,使用 Array.from 创造新数组.</h2><p><img src="/../images/2024-12-18-show.JPG" alt="效果图"><br>代码展示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">computed: &#123;</span><br><span class="line">  flattenedSceneLogData() &#123;</span><br><span class="line">    const a = this.sceneLogData?.flatMap((record) =&gt; &#123;</span><br><span class="line">      const maxLength = Math.max(</span><br><span class="line">        record.triggerInfoList?.length || 0,</span><br><span class="line">        record.actionInfoList?.length || 0</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      // 确保 sceneName 始终被包含</span><br><span class="line">      const sceneName = record.sceneName || &#x27;&#x27;;</span><br><span class="line">      const triggerRows = Array.from(&#123; length: maxLength &#125;, (_, index) =&gt; &#123;</span><br><span class="line">        const info = record.triggerInfoList?.[index] || &#123;&#125;;</span><br><span class="line">        return &#123;</span><br><span class="line">          sceneName: sceneName, // 直接从 record 获取</span><br><span class="line">          identifier: info.identifier || &#x27;&#x27;,</span><br><span class="line">          modelName: info.modelName || &#x27;&#x27;,</span><br><span class="line">          deviceNumber: info.deviceNumber || &#x27;&#x27;,</span><br><span class="line">          value: info.value || &#x27;&#x27;,</span><br><span class="line">          hitTime: info.hitTime || &#x27;&#x27;,</span><br><span class="line">          triggerCount: maxLength,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      const actionRows = Array.from(&#123; length: maxLength &#125;, (_, index) =&gt; &#123;</span><br><span class="line">        const info = record.actionInfoList?.[index] || &#123;&#125;;</span><br><span class="line">        return &#123;</span><br><span class="line">          sceneName: sceneName, // 直接从 record 获取</span><br><span class="line">          actionidentifier: info.identifier || &#x27;&#x27;,</span><br><span class="line">          operateName: info.operateName || &#x27;&#x27;,</span><br><span class="line"></span><br><span class="line">          actionmodelName: info.modelName || &#x27;&#x27;,</span><br><span class="line">          actionvalue: info.value || &#x27;&#x27;,</span><br><span class="line">          actionhitTime: info.actionTime || &#x27;&#x27;,</span><br><span class="line">          actiondeviceNumber: info.serialNumber || &#x27;&#x27;,</span><br><span class="line">          operateResult: info.operateResult || &#x27;&#x27;,</span><br><span class="line">          triggerCount: maxLength,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      const combinedRows = triggerRows.map((triggerRow, index) =&gt; (&#123;</span><br><span class="line">        ...triggerRow,</span><br><span class="line">        ...actionRows[index],</span><br><span class="line">      &#125;));</span><br><span class="line">      return combinedRows;</span><br><span class="line">    &#125;);</span><br><span class="line">    return a;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">    arraySpanMethod(&#123; row, column, rowIndex, columnIndex &#125;) &#123;</span><br><span class="line">    if (this.needToMerage.includes(column.property)) &#123;</span><br><span class="line">      // 只在第一行应用合并</span><br><span class="line">      if (rowIndex % row.triggerCount === 0) &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">          rowspan: row.triggerCount,</span><br><span class="line">          colspan: 1,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">          rowspan: 0, // 其他行不显示</span><br><span class="line">          colspan: 0,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123; rowspan: 1, colspan: 1 &#125;;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/12/2024-12-12-vue%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/12/2024-12-12-vue%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-12-12-vue问题处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-12-12 18:59:48" itemprop="dateCreated datePublished" datetime="2024-12-12T18:59:48+08:00">2024-12-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-14 17:42:40" itemprop="dateModified" datetime="2024-12-14T17:42:40+08:00">2024-12-14</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/12/12/2024-12-12-vue%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/12/12/2024-12-12-vue%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>开发环境能访问到路由，打包部署到测试环境就不能访问到路由了。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export const loadView = (view) =&gt; &#123;</span><br><span class="line">  if (process.env.NODE_ENV === &#x27;development&#x27;) &#123;</span><br><span class="line">    return (resolve) =&gt; require([`@/views/$&#123;view&#125;`], resolve)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 使用 import 实现生产环境的路由懒加载</span><br><span class="line">    return () =&gt; import(`@/views/$&#123;view&#125;`)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原因分析 环境不支持 import 语法，开发环境能支持是因为在 babel 中配置了转换插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    // https://github.com/vuejs/vue-cli/tree/master/packages/@vue/babel-preset-app</span><br><span class="line">    &#x27;@vue/cli-plugin-babel/preset&#x27;</span><br><span class="line">  ],</span><br><span class="line">  &#x27;env&#x27;: &#123;</span><br><span class="line">    &#x27;development&#x27;: &#123;</span><br><span class="line">      // babel-plugin-dynamic-import-node plugin only does one thing by converting all import() to require().</span><br><span class="line">      // This plugin can significantly increase the speed of hot updates, when you have a large number of pages.</span><br><span class="line">      &#x27;plugins&#x27;: [&#x27;dynamic-import-node&#x27;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>父组件打开子组件，给子组件赋值. 子组件不能正常更新。<br>原因分析： 代码是在 beforeUpdate 中赋父组件传来的值。在钩子函数执行后， 组件其实已经挂载， 不能实时更新。 <details>
  <summary>Vue 2 生命周期</summary>
  <h3>生命周期钩子函数</h3>
  <ol>
 <li>
   <strong>beforeCreate</strong>
   <ul>
     <li><strong>触发时机：</strong> 实例初始化之后，数据观测和事件配置之前。</li>
     <li><strong>执行次数：</strong> 创建组件实例时执行一次。</li>
   </ul>
 </li>
 <li>
   <strong>created</strong>
   <ul>
     <li><strong>触发时机：</strong> 实例已创建，数据观测和事件配置已完成，但 DOM 还未挂载。</li>
     <li><strong>执行次数：</strong> 创建组件实例时执行一次。</li>
   </ul>
 </li>
 <li>
   <strong>beforeMount</strong>
   <ul>
     <li><strong>触发时机：</strong> 在挂载开始之前被调用，相关的 render 函数首次被调用。</li>
     <li><strong>执行次数：</strong> 组件实例挂载时执行一次。</li>
   </ul>
 </li>
 <li>
   <strong>mounted</strong>
   <ul>
     <li><strong>触发时机：</strong> 组件挂载到 DOM 后调用，所有子组件也已挂载。</li>
     <li><strong>执行次数：</strong> 组件实例挂载时执行一次。</li>
   </ul>
 </li>
 <li>
   <strong>beforeUpdate</strong>
   <ul>
     <li><strong>触发时机：</strong> 数据更新时调用，发生在虚拟 DOM 重新渲染之前。</li>
     <li><strong>执行次数：</strong> 每次数据更新时都会执行一次。</li>
   </ul>
 </li>
 <li>
   <strong>updated</strong>
   <ul>
     <li><strong>触发时机：</strong> 数据更新后调用，虚拟 DOM 重新渲染并应用到 DOM 后。</li>
     <li><strong>执行次数：</strong> 每次数据更新时都会执行一次。</li>
   </ul>
 </li>
 <li>
   <strong>beforeDestroy</strong>
   <ul>
     <li><strong>触发时机：</strong> 实例销毁之前调用，实例仍然可以访问。</li>
     <li><strong>执行次数：</strong> 组件实例销毁时执行一次。</li>
   </ul>
 </li>
 <li>
   <strong>destroyed</strong>
   <ul>
     <li><strong>触发时机：</strong> 实例销毁后调用，所有的事件监听器和子实例都被移除。</li>
     <li><strong>执行次数：</strong> 组件实例销毁时执行一次。</li>
   </ul>
 </li>
  </ol>
  <h3>执行顺序</h3>
  <ol>
 <li>beforeCreate</li>
 <li>created</li>
 <li>beforeMount</li>
 <li>mounted</li>
 <li>beforeUpdate (在数据更新时)</li>
 <li>updated</li>
 <li>beforeDestroy</li>
 <li>destroyed</li>
  </ol>
</details>
 解决办法：使用watch监听属性变化</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">watch: &#123;</span><br><span class="line"> open: function (newVal, oldVal) &#123;</span><br><span class="line">   if (this.selectType == 1) &#123;</span><br><span class="line">     this.queryParams.productId =</span><br><span class="line">       this.triggerList[0]?.productId ?? this.options[0].value;</span><br><span class="line">     this.deviceList = this.triggerList;</span><br><span class="line">   &#125;</span><br><span class="line">   if (this.selectType == 2) &#123;</span><br><span class="line">     this.queryParams.productId =</span><br><span class="line">       this.actionList[0]?.productId ?? this.options[0].value;</span><br><span class="line">     this.deviceList = this.actionList;</span><br><span class="line">   &#125;</span><br><span class="line">   this.$nextTick(() =&gt; &#123;</span><br><span class="line">     this.$refs.singleTable.clearSelection();</span><br><span class="line">     this.deviceList.forEach((element) =&gt; &#123;</span><br><span class="line">       this.$refs.singleTable.toggleRowSelection(element);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>双向绑定失效</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/** 数据类型改变 */</span><br><span class="line">dataTypeChange(val) &#123;</span><br><span class="line">  this.form.specs = &#123;&#125;;</span><br><span class="line">  if (val == &#x27;enum&#x27;) &#123;</span><br><span class="line">     this.form.specs.enumList = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>原因分析: 直接给一个对象的属性赋值，vue 无法检测到这种变化。</p>
<h3 id="数据绑定失效的场景"><a href="#数据绑定失效的场景" class="headerlink" title="数据绑定失效的场景"></a>数据绑定失效的场景</h3><p>在 Vue 中，双向绑定是通过 <code>v-model</code> 指令实现的，通常用于表单元素（如 <code>&lt;input&gt;</code>、<code>&lt;textarea&gt;</code> 和 <code>&lt;select&gt;</code>）。然而，在某些情况下，双向绑定可能会失效。以下是一些常见的场景：</p>
<ol>
<li><p><strong>未正确使用 <code>v-model</code></strong></p>
<ul>
<li>确保在表单元素上使用 <code>v-model</code> 指令。如果在非表单元素上使用，双向绑定将不会生效。</li>
</ul>
</li>
<li><p><strong>对象属性未初始化</strong>：</p>
<ul>
<li>如果 <code>v-model</code> 绑定的对象属性未在 Vue 实例的 <code>data</code> 中初始化，Vue 无法追踪该属性的变化。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">form</span>: &#123;&#125; <span class="comment">// 这里没有 form.input</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 <code>v-if</code> 和 <code>v-for</code></strong></p>
<ul>
<li>当使用 <code>v-if</code> 来控制一个组件的渲染时，确保绑定的数据在条件满足时已经存在。</li>
<li>在使用 <code>v-for</code> 时，确保每个元素的 <code>key</code> 是唯一的，以便 Vue 能够正确地追踪每个元素。</li>
</ul>
</li>
<li><p><strong>直接修改数组或对象</strong>：</p>
<ul>
<li>直接修改数组的元素或对象的属性可能不会触发视图更新。例如，使用索引直接赋值或添加新属性时。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">array</span>[index] = newValue; <span class="comment">// 不会触发视图更新</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">object</span>.<span class="property">newProp</span> = value; <span class="comment">// 不会触发视图更新</span></span><br></pre></td></tr></table></figure>

<ul>
<li>应使用 Vue 提供的变更方法，如 <code>Vue.set()</code> 或 <code>this.$set()</code>。</li>
</ul>
</li>
<li><p><strong>使用了原生 DOM 事件</strong>：</p>
<ul>
<li>如果在组件中使用原生 DOM 事件（例如 <code>addEventListener</code>）而不是 Vue 的事件处理机制，可能会导致双向绑定失效。应使用 Vue 的事件处理（如 <code>@input</code>）来确保数据更新。</li>
</ul>
</li>
<li><p><strong>组件的 <code>props</code> 是只读的</strong>：</p>
<ul>
<li>如果在子组件中使用 <code>v-model</code> 绑定父组件的 <code>props</code>，并试图在子组件中修改这些 <code>props</code>，将导致双向绑定失效。<code>props</code> 是只读的，子组件应通过事件通知父组件进行数据更新。</li>
</ul>
</li>
<li><p><strong>使用 <code>v-model</code> 绑定非基本类型</strong>：</p>
<ul>
<li><code>v-model</code> 通常用于基本类型（如字符串、数字等），如果绑定的是一个复杂的数据结构，可能会导致意外的行为。</li>
</ul>
</li>
<li><p><strong>数据更新不在 Vue 的响应系统内</strong>：</p>
<ul>
<li>如果数据更新是在 Vue 的响应系统之外进行的（例如通过第三方库或直接操作 DOM），则 Vue 将无法检测到这些变化。</li>
</ul>
</li>
<li><p><strong>使用 <code>v-model</code> 绑定自定义组件</strong>：</p>
<ul>
<li>如果自定义组件未正确实现 <code>v-model</code> 的支持（即未发出 <code>input</code> 事件），则双向绑定将失效。自定义组件需要在 <code>props</code> 中接收值，并在值变化时使用 <code>$emit(&#39;input&#39;, newValue)</code> 发出事件。</li>
</ul>
</li>
<li><p><strong>使用 <code>v-model</code> 绑定计算属性</strong>：</p>
<ul>
<li>计算属性是只读的，不能直接用于双向绑定。如果需要双向绑定，应该使用数据属性。</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/19/2024-11-19-Transactional-%E6%B3%A8%E8%A7%A3%E5%A4%B1%E6%95%88%E7%9A%84%E5%9C%BA%E6%99%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/19/2024-11-19-Transactional-%E6%B3%A8%E8%A7%A3%E5%A4%B1%E6%95%88%E7%9A%84%E5%9C%BA%E6%99%AF/" class="post-title-link" itemprop="url">2024-11-19-@Transactional 注解失效的场景</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-11-19 20:12:18 / 修改时间：20:46:33" itemprop="dateCreated datePublished" datetime="2024-11-19T20:12:18+08:00">2024-11-19</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/11/19/2024-11-19-Transactional-%E6%B3%A8%E8%A7%A3%E5%A4%B1%E6%95%88%E7%9A%84%E5%9C%BA%E6%99%AF/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/11/19/2024-11-19-Transactional-%E6%B3%A8%E8%A7%A3%E5%A4%B1%E6%95%88%E7%9A%84%E5%9C%BA%E6%99%AF/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-没有开启事务管理器-EnableTransactionManagement，项目自定义了事务管理器，导致springboot的-Transactional-失效"><a href="#1-没有开启事务管理器-EnableTransactionManagement，项目自定义了事务管理器，导致springboot的-Transactional-失效" class="headerlink" title="1. 没有开启事务管理器@EnableTransactionManagement，项目自定义了事务管理器，导致springboot的@Transactional 失效"></a>1. 没有开启事务管理器@EnableTransactionManagement，项目自定义了事务管理器，导致springboot的@Transactional 失效</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">    @Configuration</span><br><span class="line">    @ConditionalOnClass(ReflectionWorld.class)</span><br><span class="line">//    @ConditionalOnProperty(prefix = &quot;ftf.transaction&quot;, value = &quot;aspectJ&quot;, matchIfMissing = false, havingValue = &quot;true&quot;)</span><br><span class="line">    public static class AspectJTransactionConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 事务属性值</span><br><span class="line">         */</span><br><span class="line">        @Autowired</span><br><span class="line">        private TransactionProperties transactionProperties;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 创建切面</span><br><span class="line">         *</span><br><span class="line">         * @return DefaultBeanFactoryPointcutAdvisor</span><br><span class="line">         * @author henry</span><br><span class="line">         */</span><br><span class="line">        @Bean</span><br><span class="line">//        @ConditionalOnMissingBean(name = &quot;aspectJTransactionBeanFactoryPointcutAdvisor&quot;)</span><br><span class="line">        public DefaultBeanFactoryPointcutAdvisor aspectJTransactionBeanFactoryPointcutAdvisor() &#123;</span><br><span class="line">            DefaultBeanFactoryPointcutAdvisor defaultBeanFactoryPointcutAdvisor = new DefaultBeanFactoryPointcutAdvisor();</span><br><span class="line">            defaultBeanFactoryPointcutAdvisor.setAdvice(aspectJTransactionInterceptor());</span><br><span class="line">            defaultBeanFactoryPointcutAdvisor.setPointcut(aspectJTransactionExpressionPointcut());</span><br><span class="line">            return defaultBeanFactoryPointcutAdvisor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 创建切点</span><br><span class="line">         *</span><br><span class="line">         * @return AspectJExpressionPointcut</span><br><span class="line">         * @author henry</span><br><span class="line">         */</span><br><span class="line">        @Bean</span><br><span class="line">//        @ConditionalOnMissingBean(name = &quot;aspectJTransactionExpressionPointcut&quot;)</span><br><span class="line">        public AspectJExpressionPointcut aspectJTransactionExpressionPointcut() &#123;</span><br><span class="line">            AspectJExpressionPointcut aspectJExpressionPointcut = new AspectJExpressionPointcut();</span><br><span class="line">            aspectJExpressionPointcut.setExpression(transactionProperties.getExpression());</span><br><span class="line">            return aspectJExpressionPointcut;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 创建事务属性源，需要对哪些方法进行拦截，以及一些属性值</span><br><span class="line">         *</span><br><span class="line">         * @return TransactionAttributeSource</span><br><span class="line">         * @author henry</span><br><span class="line">         */</span><br><span class="line">        @Bean</span><br><span class="line">//        @ConditionalOnMissingBean(name = &quot;aspectJTransactionAttributeSource&quot;)</span><br><span class="line">        public TransactionAttributeSource aspectJTransactionAttributeSource() &#123;</span><br><span class="line">            Map&lt;String, String&gt; attributes = transactionProperties.getAttributes();</span><br><span class="line">            NameMatchTransactionAttributeSource transactionAttributeSource = new NameMatchTransactionAttributeSource();</span><br><span class="line">            if (MapUtils.isNotEmpty(attributes)) &#123;</span><br><span class="line">                Properties transactionAttributes = new Properties();</span><br><span class="line">                for (Map.Entry&lt;String, String&gt; map : attributes.entrySet()) &#123;</span><br><span class="line">                    transactionAttributes.setProperty(map.getKey(), map.getValue());</span><br><span class="line">                &#125;</span><br><span class="line">                transactionAttributeSource.setProperties(transactionAttributes);</span><br><span class="line">            &#125;</span><br><span class="line">            return transactionAttributeSource;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 创建事务拦截器</span><br><span class="line">         *</span><br><span class="line">         * @return TransactionInterceptor</span><br><span class="line">         * @author henry</span><br><span class="line">         */</span><br><span class="line">        @Bean</span><br><span class="line">//        @ConditionalOnMissingBean(name = &quot;aspectJTransactionInterceptor&quot;)</span><br><span class="line">        public TransactionInterceptor aspectJTransactionInterceptor() &#123;</span><br><span class="line">            TransactionInterceptor interceptor = new TransactionInterceptor();</span><br><span class="line">            interceptor.setTransactionAttributeSource(aspectJTransactionAttributeSource());</span><br><span class="line">            interceptor.setTransactionManagerBeanName(SystemImplConst.TRANSACTION_MANAGER_NAME);</span><br><span class="line">            return interceptor;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/04/2024-11-04-%E5%B9%BF%E4%B8%9C%E7%A7%BB%E5%8A%A8iot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%84%9F%E6%82%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/04/2024-11-04-%E5%B9%BF%E4%B8%9C%E7%A7%BB%E5%8A%A8iot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%84%9F%E6%82%9F/" class="post-title-link" itemprop="url">2024-11-04-广东移动iot项目开发感悟</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-11-04 21:09:15" itemprop="dateCreated datePublished" datetime="2024-11-04T21:09:15+08:00">2024-11-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-11 10:13:19" itemprop="dateModified" datetime="2024-11-11T10:13:19+08:00">2024-11-11</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/11/04/2024-11-04-%E5%B9%BF%E4%B8%9C%E7%A7%BB%E5%8A%A8iot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%84%9F%E6%82%9F/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/11/04/2024-11-04-%E5%B9%BF%E4%B8%9C%E7%A7%BB%E5%8A%A8iot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%84%9F%E6%82%9F/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>参加广东移动iot项目，核心功能：对设备（传感器，摄像头 等）进行管理, 监控设备的状态。当设备发生状态时，能根据系统对对应设备配置的规则，控制设备执行一些动作， 报警，移动，拍照。</p>
<h4 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h4><p>前端 react http<br>后端 springboot,sftp,mqtt,websocket,redis,mysql</p>
<p>核心功能实现思路：</p>
<ol>
<li>使用Mqtt技术对设备的状态进行监听。然后使用线程池技术处理监听的设备，判断该设备是否触发规则<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private static final Logger logger = LoggerFactory.getLogger(SceneMessageListener.class);</span><br><span class="line">private final ThreadPoolExecutor zigbeeExecutor = ThreadPoolFactory.getZigbeeExecutor();</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void messageArrived(String topic, MqttMessage mqttMessage) &#123;</span><br><span class="line">    String payload = new String(mqttMessage.getPayload(), StandardCharsets.UTF_8);</span><br><span class="line">    zigbeeExecutor.execute(new SceneRuleCheckThread(topic, payload));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>使用redis缓存 把设备数据 缓存到redis 中<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        String piMacAddress = topic.split(&quot;/&quot;)[1];</span><br><span class="line">        String friendlyName = topic.split(&quot;/&quot;)[2];</span><br><span class="line">        String redisKey = piMacAddress + &quot;:&quot; + friendlyName;</span><br><span class="line">        IotDevice zigbeeDevice = (IotDevice) CacheUtil.hget(IotConst.REDIS_KEY_MAC_IEEE_MAP, redisKey);</span><br><span class="line">        if (zigbeeDevice == null) &#123;</span><br><span class="line">            logger.info(&quot;Zigbee设备: &#123;&#125;未被缓存&quot;, redisKey);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        Integer deviceId = zigbeeDevice.getDeviceId();</span><br><span class="line">        Map&lt;String, Object&gt; deviceData = new HashMap&lt;&gt;();</span><br><span class="line">        if (topic.endsWith(&quot;/availability&quot;)) &#123;</span><br><span class="line">            boolean offline = &quot;OFFLINE&quot;.equals(payload.toUpperCase(Locale.ROOT));</span><br><span class="line">            deviceData.put(&quot;OFFLINE&quot;, offline);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            deviceData = JsonUtil.getMap(payload);</span><br><span class="line">        &#125;</span><br><span class="line">        sceneInfoService.checkDeviceTriggerRule(deviceId, deviceData);</span><br><span class="line">    &#125;</span><br><span class="line">3. 在规则表中加了一个字段，当设备状态变更时，如果规则满足则把该状态弄出true。</span><br><span class="line">4. 最后使用定时任务扫描库表。当该设备的所有规则都为true 时。触发对应的行为</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>技术实现简单，成本低，1个月开发完成</li>
<li>实时性很低，并发也很低，如果数据量很大，会有性能问题。</li>
<li>设备接入只实现了mqtt 接入，扩展性差。</li>
</ol>
<h4 id="ThingsBoard-开源项目学习"><a href="#ThingsBoard-开源项目学习" class="headerlink" title="ThingsBoard 开源项目学习"></a>ThingsBoard 开源项目学习</h4><ol>
<li>在 ThingsBoard 中，可以通过其 规则链（Rule Chain） 和 规则节点（Rule Nodes） 来实现条件报警逻辑</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-10-19-使用多线程调用外部接口缺陷处理 -Use multithreading to invoke external interface defect handling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-10-19 21:55:19" itemprop="dateCreated datePublished" datetime="2024-10-19T21:55:19+08:00">2024-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-10-26 20:01:57" itemprop="dateModified" datetime="2024-10-26T20:01:57+08:00">2024-10-26</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述-Problem-description"><a href="#问题描述-Problem-description" class="headerlink" title="问题描述 - Problem description"></a>问题描述 - Problem description</h3><p>调用外部系统同步机架下的u位数据，发现有的u位数据没有正常同步过来。 -The external system is called to synchronize the U-bit data under the rack, and the existing U-bit data is not synchronized properly.<br>因为u位数据数量很多，对方系统没有提供批量同步的接口。所以使用多线程的方法调用。下面是调用代码。-Because of the large amount of U-bit data, the other system does not provide an interface for batch synchronization. So use multi-threaded method calls. Here’s the call code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">log.info(&quot;开始同步机架U位数据....&quot;);</span><br><span class="line">     long startTime = System.currentTimeMillis();</span><br><span class="line">     List&lt;RoomckCloudResCabinet&gt; roomckCloudResCabinets = roomckCloudResCabinetMapper.queryAllCloudData();</span><br><span class="line">     log.info(&quot;机架数据数量：&quot; + roomckCloudResCabinets.size());</span><br><span class="line">     if (roomckCloudResCabinets.isEmpty()) &#123;</span><br><span class="line">         return;</span><br><span class="line">     &#125;</span><br><span class="line">     String nonce = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span><br><span class="line">     Map&lt;String, String&gt; header = GetCloudSignUtil.getHeaders(ak,</span><br><span class="line">            sk, System.currentTimeMillis(), nonce);</span><br><span class="line">     String url = cloudServerUrl + ApiSkAKConst.UCABINETDATA_SYNC_URL;</span><br><span class="line">     CommonRequestDTO commonRequestDTO = new CommonRequestDTO();</span><br><span class="line">     List&lt;CompletableFuture&gt; futureList = new ArrayList&lt;&gt;();</span><br><span class="line">     for (RoomckCloudResCabinet roomckCloudResCabinet : roomckCloudResCabinets) &#123;</span><br><span class="line">         CompletableFuture future = CompletableFuture.runAsync(new Runnable() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public void run() &#123;</span><br><span class="line">                 try &#123;</span><br><span class="line">                     commonRequestDTO.setId(roomckCloudResCabinet.getId());</span><br><span class="line">                     String response = HttpUtil.createPost(url).addHeaders(header).body(JSONUtil.toJsonStr(commonRequestDTO)).execute().body();</span><br><span class="line">                     CabinetUResultDTO  result =  JSON.parseObject(response).toJavaObject(CabinetUResultDTO.class);</span><br><span class="line">                     if (result.getResultObject() == null || result.getResultObject().isEmpty()) &#123;</span><br><span class="line">                         return;</span><br><span class="line">                     &#125;</span><br><span class="line">                     if (result.getResultObject().get(0) == null) &#123;</span><br><span class="line">                         return;</span><br><span class="line">                     &#125;</span><br><span class="line">                     List&lt;UCabinetDataDTO&gt; uCabinetDataDTOList = JSONArray.parseArray(result.getResultObject().get(0).getList().toString(), UCabinetDataDTO.class);</span><br><span class="line">                     List&lt;RoomckCloudResU&gt; roomckCloudResUS = new ArrayList&lt;&gt;();</span><br><span class="line">                     if (uCabinetDataDTOList != null) &#123;</span><br><span class="line">                         for (UCabinetDataDTO uCabinetDataDTO : uCabinetDataDTOList) &#123;</span><br><span class="line">                             RoomckCloudResU roomckResU = new RoomckCloudResU();</span><br><span class="line">                             transferUCabinet(roomckCloudResCabinet, uCabinetDataDTO, roomckResU);</span><br><span class="line">                             roomckCloudResUS.add(roomckResU);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                     roomckCloudUsCabinetMapper.insertOrUpdateBatch(roomckCloudResUS);</span><br><span class="line">                 &#125;</span><br><span class="line">                 catch (Exception e) &#123;</span><br><span class="line">                     log.info(&quot;机架id为&quot; + roomckCloudResCabinet.getId() + &quot;下的U位数据同步失败。&quot;);</span><br><span class="line">                     log.error(e.getMessage(), e);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;, ThreadUtils.ioPool);</span><br><span class="line">         futureList.add(future);</span><br><span class="line">     &#125;</span><br><span class="line">     CompletableFuture.allOf(futureList.toArray(new CompletableFuture[0])).join();</span><br><span class="line">     log.info(&quot;机架U位同步完成.耗时&quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="问题分析-problem-analysis"><a href="#问题分析-problem-analysis" class="headerlink" title="问题分析 - problem analysis"></a>问题分析 - problem analysis</h3><ol>
<li>我犯了一个很基础的错误，commonRequestDTO 是多线程共享的，赋值的时候没有加锁，导致传的参数可能被其他线程覆盖了。所以有的u位数据没有同步。 - I made a very basic mistake, commonRequestDTO is shared by multiple threads, and there is no lock when assigning the value, which causes the passed parameters to be overridden by other threads. So some U-bit data is not synchronized</li>
<li>分析日志发现。当接口多次调用的时候。对方服务器接口会返回500，拒绝服务. 代码没有重试机制，缺少健壮性。</li>
</ol>
<ul>
<li>Analyze log findings. When an interface is called multiple times. The other server interface will return a 500 and refuse service. The code has no retry mechanism and lacks robustness.</li>
</ul>
<ol start="3">
<li>调用外部接口获取密钥的 header 是所有线程共用的。而这个同步数据有点多。大概需要30分钟才能同步完成。而接口的密钥有效性只有2分钟，所以在2分钟之后后面再次调用接口会出现认证失败。</li>
</ol>
<ul>
<li>The header that calls an external interface to obtain a key is shared by all threads. And this synchronization data is a bit much. It takes about 30 minutes to sync. The key validity of the interface is only 2 minutes, so if the API is called again after 2 minutes, the authentication will fail</li>
</ul>
<h3 id="问题解决-problem-solution"><a href="#问题解决-problem-solution" class="headerlink" title="问题解决 - problem solution"></a>问题解决 - problem solution</h3><ol>
<li>对commonRequestDTO.setId(roomckCloudResCabinet.getId()); 这行代码加锁 -Lock the line of code: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> synchronized (commonRequestDTO) &#123;</span><br><span class="line">                    commonRequestDTO.setId(roomckCloudResCabinet.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>代码加上重试机制 优化后代码 - Code with retry mechanism, optimized code as follows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">@Async</span><br><span class="line">@Scheduled(cron = &quot;$&#123;task.ucabinetdata.sync.cron&#125;&quot;)</span><br><span class="line">@SchedulerLock(name = &quot;CloudCt_task.ucabinetdata.sync&quot;, lockAtLeastForString = &quot;PT30M&quot;, lockAtMostForString = &quot;PT60M&quot;)</span><br><span class="line">public void syncStation() &#123;</span><br><span class="line">    log.info(&quot;开始同步机架U位数据....&quot;);</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line">    List&lt;RoomckCloudResCabinet&gt; roomckCloudResCabinets = roomckCloudResCabinetMapper.queryAllCloudData();</span><br><span class="line">    log.info(&quot;机架数据数量：&quot; + roomckCloudResCabinets.size());</span><br><span class="line">    if (roomckCloudResCabinets.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    String nonce = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span><br><span class="line">    Map&lt;String, String&gt; header = GetCloudSignUtil.getHeaders(ak,</span><br><span class="line">           sk, System.currentTimeMillis(), nonce);</span><br><span class="line">    String url = cloudServerUrl + ApiSkAKConst.UCABINETDATA_SYNC_URL;</span><br><span class="line">    CommonRequestDTO commonRequestDTO = new CommonRequestDTO();</span><br><span class="line">    List&lt;CompletableFuture&gt; futureList = new ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;RoomckCloudResCabinet&gt; failedCabinets = Collections.synchronizedList(new ArrayList&lt;&gt;());</span><br><span class="line">    for (RoomckCloudResCabinet roomckCloudResCabinet : roomckCloudResCabinets) &#123;</span><br><span class="line">        CompletableFuture future = CompletableFuture.runAsync(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    synchronized (commonRequestDTO) &#123;</span><br><span class="line">                        commonRequestDTO.setId(roomckCloudResCabinet.getId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    String response = HttpUtil.createPost(url).addHeaders(header).body(JSONUtil.toJsonStr(commonRequestDTO)).execute().body();</span><br><span class="line">                    CabinetUResultDTO  result =  JSON.parseObject(response).toJavaObject(CabinetUResultDTO.class);</span><br><span class="line">                    if (result.getResultObject() == null || result.getResultObject().isEmpty()) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (result.getResultObject().get(0) == null) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    List&lt;UCabinetDataDTO&gt; uCabinetDataDTOList = JSONArray.parseArray(result.getResultObject().get(0).getList().toString(), UCabinetDataDTO.class);</span><br><span class="line">                    List&lt;RoomckCloudResU&gt; roomckCloudResUS = new ArrayList&lt;&gt;();</span><br><span class="line">                    if (uCabinetDataDTOList != null) &#123;</span><br><span class="line">                        for (UCabinetDataDTO uCabinetDataDTO : uCabinetDataDTOList) &#123;</span><br><span class="line">                            RoomckCloudResU roomckResU = new RoomckCloudResU();</span><br><span class="line">                            transferUCabinet(roomckCloudResCabinet, uCabinetDataDTO, roomckResU);</span><br><span class="line">                            roomckCloudResUS.add(roomckResU);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    roomckCloudUsCabinetMapper.insertOrUpdateBatch(roomckCloudResUS);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception e) &#123;</span><br><span class="line">                    log.info(&quot;机架id为&quot; + roomckCloudResCabinet.getId() + &quot;下的U位数据同步失败。&quot;);</span><br><span class="line">                    failedCabinets.add(roomckCloudResCabinet);</span><br><span class="line">                    log.error(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, ThreadUtils.ioPool);</span><br><span class="line">        futureList.add(future);</span><br><span class="line">    &#125;</span><br><span class="line">    CompletableFuture.allOf(futureList.toArray(new CompletableFuture[0])).join();</span><br><span class="line">    log.info(&quot;机架U位同步完成.耗时&quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;);</span><br><span class="line">    // 处理失败的请求</span><br><span class="line">    if (!failedCabinets.isEmpty()) &#123;</span><br><span class="line">        log.info(&quot;有&quot; + failedCabinets.size() + &quot;个机架调用接口失败。开始发起重试&quot;);</span><br><span class="line">        retryFailedRequests(failedCabinets, header, url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">private void retryFailedRequests(List&lt;RoomckCloudResCabinet&gt; failedCabinets, Map&lt;String, String&gt; header, String url) &#123;</span><br><span class="line">    CommonRequestDTO commonRequestDTO = new CommonRequestDTO();</span><br><span class="line">    for (RoomckCloudResCabinet cabinet : failedCabinets) &#123;</span><br><span class="line">        int retryCount = 0;</span><br><span class="line">        boolean success = false;</span><br><span class="line">        while (retryCount &lt; MAX_RETRIES &amp;&amp; !success) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                synchronized (commonRequestDTO) &#123;</span><br><span class="line">                    commonRequestDTO.setId(cabinet.getId());</span><br><span class="line">                &#125;</span><br><span class="line">                String response = HttpUtil.createPost(url)</span><br><span class="line">                        .addHeaders(header)</span><br><span class="line">                        .body(JSONUtil.toJsonStr(commonRequestDTO))</span><br><span class="line">                        .execute().body();</span><br><span class="line">                CabinetUResultDTO result = JSON.parseObject(response).toJavaObject(CabinetUResultDTO.class);</span><br><span class="line">                if (result.getResultObject() == null || result.getResultObject().isEmpty()) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if (result.getResultObject().get(0) == null) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;UCabinetDataDTO&gt; uCabinetDataDTOList = JSONArray.parseArray(</span><br><span class="line">                        result.getResultObject().get(0).getList().toString(), UCabinetDataDTO.class);</span><br><span class="line">                List&lt;RoomckCloudResU&gt; roomckCloudResUS = new ArrayList&lt;&gt;();</span><br><span class="line">                if (uCabinetDataDTOList != null) &#123;</span><br><span class="line">                    for (UCabinetDataDTO uCabinetDataDTO : uCabinetDataDTOList) &#123;</span><br><span class="line">                        RoomckCloudResU roomckResU = new RoomckCloudResU();</span><br><span class="line">                        transferUCabinet(cabinet, uCabinetDataDTO, roomckResU);</span><br><span class="line">                        roomckCloudResUS.add(roomckResU);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                roomckCloudUsCabinetMapper.insertOrUpdateBatch(roomckCloudResUS);</span><br><span class="line">                success = true; // 如果成功则退出重试循环</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                retryCount++;</span><br><span class="line">                log.info(&quot;机架id为&quot; + cabinet.getId() + &quot;的重试第&quot; + retryCount + &quot;次失败。&quot;);</span><br><span class="line">                log.error(e.getMessage(), e);</span><br><span class="line">                if (retryCount &gt;= MAX_RETRIES) &#123;</span><br><span class="line">                    log.info(&quot;机架id为&quot; + cabinet.getId() + &quot;的重试已达到最大次数。&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>每次调用接口的时候都重新获取密钥 把 Map&lt;String, String&gt; header &#x3D; GetCloudSignUtil.getHeaders(ak,sk, System.currentTimeMillis(), nonce); 放到方法内部。</li>
</ol>
<ul>
<li>Each time the interface is called, the key is re-obtained, and the <code>Map&lt;String, String&gt; header = GetCloudSignUtil.getHeaders(ak, sk, System.currentTimeMillis(), nonce);</code> is placed within the method.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-10-07-手机app端登录不上,session获取不到,问题处理 - The mobile app cannot be logged in, the session cannot be obtained, and the problem is handled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-10-07 16:43:34" itemprop="dateCreated datePublished" datetime="2024-10-07T16:43:34+08:00">2024-10-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-10-19 22:01:48" itemprop="dateModified" datetime="2024-10-19T22:01:48+08:00">2024-10-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述-Problem-description"><a href="#问题描述-Problem-description" class="headerlink" title="问题描述 - Problem description"></a>问题描述 - Problem description</h3><p>web 能正常登录机房系统。 手机app却不能正常登录 - Web can log in to the computer room system normally. The mobile app cannot be logged in normally</p>
<h2 id="以下是报错日志-The-following-is-the-error-log报错代码-error-code通过日志分析。发现当app登录时，一直获取不到对应的sessionID-但是很奇怪的是app端和web端后台都是访问同一个接口。web-端能正常登录，可以获取到session，app端却不能。使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。-因为app端配置了反向代理。访问的登录接口为-http-172-21-72-176-8311-roomck-app-aiFactoryServer-system-session-verificationCode，它带了-roomck-app-前缀。-而服务器设置了-Path-aiFactoryServer-HttpOnly-路径必须以-aiFactoryServer开头才会携带cookie-所以app一直不能正常登录系统。"><a href="#以下是报错日志-The-following-is-the-error-log报错代码-error-code通过日志分析。发现当app登录时，一直获取不到对应的sessionID-但是很奇怪的是app端和web端后台都是访问同一个接口。web-端能正常登录，可以获取到session，app端却不能。使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。-因为app端配置了反向代理。访问的登录接口为-http-172-21-72-176-8311-roomck-app-aiFactoryServer-system-session-verificationCode，它带了-roomck-app-前缀。-而服务器设置了-Path-aiFactoryServer-HttpOnly-路径必须以-aiFactoryServer开头才会携带cookie-所以app一直不能正常登录系统。" class="headerlink" title="以下是报错日志 -  The following is the error log报错代码 - error code通过日志分析。发现当app登录时，一直获取不到对应的sessionID. 但是很奇怪的是app端和web端后台都是访问同一个接口。web 端能正常登录，可以获取到session，app端却不能。使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。 因为app端配置了反向代理。访问的登录接口为 http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode，它带了 &#x2F;roomck-app 前缀。 而服务器设置了 Path&#x3D;&#x2F;aiFactoryServer; HttpOnly 路径必须以&#x2F;aiFactoryServer开头才会携带cookie,所以app一直不能正常登录系统。"></a>以下是报错日志 -  The following is the error log<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2024-10-07 15:33:03.366  INFO 19 --- [nio-7106-exec-3] .a.a.s.s.FormLoginUsernamePasswordFilter : requestSessionId= null</span><br><span class="line">2024-10-07 15:33:03.366  INFO 19 --- [nio-7106-exec-3] .a.a.s.s.FormLoginUsernamePasswordFilter : session.getId()= BECF178C43BE3DD1B060A3775EE5E0F5</span><br><span class="line">2024-10-07 15:33:03.366  INFO 19 --- [nio-7106-exec-3] .a.a.s.s.FormLoginUsernamePasswordFilter : session.getId()= BECF178C43BE3DD1B060A3775EE5E0F5</span><br><span class="line">2024-10-07 15:33:03.367 ERROR 19 --- [nio-7106-exec-3] c.i.a.c.e.h.C.doFilter() Line: 38        : CommonExceptionHandlerFilter拦截异常null</span><br><span class="line">java.lang.NullPointerException: null</span><br><span class="line">        at com.iwhalecloud.aiFactory.auth.server.security.FormLoginUsernamePasswordFilter.checkVerificationCode(FormLoginUsernamePasswordFilter.java:737) ~[common-auth-server-1.0.jar!/:na]</span><br><span class="line">        at com.iwhalecloud.aiFactory.auth.server.security.FormLoginUsernamePasswordFilter.attemptAuthentication(FormLoginUsernamePasswordFilter.java:396) ~[common-auth-server-1.0.jar!/:na]</span><br><span class="line">        at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:231) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:221) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:361) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>报错代码 - error code<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String verificationCode = portalSessionUtil.getLocalSessionAttr(session.getId(), &quot;VERIFICATION_CODE&quot;).toString();</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>通过日志分析。发现当app登录时，一直获取不到对应的sessionID. 但是很奇怪的是app端和web端后台都是访问同一个接口。web 端能正常登录，可以获取到session，app端却不能。<br>使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。 因为app端配置了反向代理。访问的登录接口为 <a target="_blank" rel="noopener" href="http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode%EF%BC%8C%E5%AE%83%E5%B8%A6%E4%BA%86">http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode，它带了</a> &#x2F;roomck-app 前缀。 而服务器设置了 Path&#x3D;&#x2F;aiFactoryServer; HttpOnly 路径必须以&#x2F;aiFactoryServer开头才会携带cookie,所以app一直不能正常登录系统。</h2><p>Through log analysis, it was found that when the app logs in, it consistently fails to obtain the corresponding sessionID. However, it is quite strange that both the app side and the web backend are accessing the same interface. The web side can log in normally and obtain a session, but the app side cannot.</p>
<p>Continuously debugged using postMan. Finally, the problem was found. When accessing the interface from the app end, cookies are not set. This is because the app end is configured with a reverse proxy. The login interface accessed is <a target="_blank" rel="noopener" href="http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode">http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode</a>, which includes the &#x2F;roomck-app prefix. However, the server is set to Path&#x3D;&#x2F;aiFactoryServer; HttpOnly, and the path must start with &#x2F;aiFactoryServer to carry the cookie. Therefore, the app has been unable to log in to the system normally.</p>
<h3 id="解决办法-Solution-Method"><a href="#解决办法-Solution-Method" class="headerlink" title="解决办法 - Solution Method"></a>解决办法 - Solution Method</h3><p>为了不增加安全风险，前端调整访问路径。并在nginx 增加对应的代理规则 - In order not to increase security risks, the front-end adjusts the access path and add the corresponding proxy rule to nginx</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-09-10 sftp上传下载问题处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-09-10 16:42:15" itemprop="dateCreated datePublished" datetime="2024-09-10T16:42:15+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-11 11:32:42" itemprop="dateModified" datetime="2024-09-11T11:32:42+08:00">2024-09-11</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="sftp-下载调试"><a href="#sftp-下载调试" class="headerlink" title="sftp 下载调试"></a>sftp 下载调试</h3><p>公司sftp服务器因安全策略本地无法直接连接。不好调试问题。本机windows安装sftp服务.<br>下载freeSSHd 作为sftp 服务端，下载FileZilla 做客户端。<br>调试上传功能无问题，下载的时候出现 java.io.IOException: Pipe closed 下载文件内容无法正常下载<br>下载代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public InputStream downloadFile(String filePath, int operationTimeout) &#123;</span><br><span class="line">      ExecutorService executor = Executors.newSingleThreadExecutor();</span><br><span class="line">      Future&lt;InputStream&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">          ChannelSftp channelSftp = null;</span><br><span class="line">          try &#123;</span><br><span class="line">              channelSftp = setupJsch();</span><br><span class="line">              return channelSftp.get(filePath);</span><br><span class="line">          &#125; catch (Exception e) &#123;</span><br><span class="line">              log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">              throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">          &#125; finally &#123;</span><br><span class="line">              if (channelSftp != null &amp;&amp; channelSftp.isConnected()) &#123;</span><br><span class="line">                  channelSftp.disconnect();</span><br><span class="line">                  try &#123;</span><br><span class="line">                      channelSftp.getSession().disconnect();</span><br><span class="line">                  &#125; catch (JSchException e) &#123;</span><br><span class="line">                      log.error(&quot;SFTP 会话断开失败&quot;, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      try &#123;</span><br><span class="line">          return future.get(operationTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">      &#125; catch (TimeoutException e) &#123;</span><br><span class="line">          future.cancel(true);</span><br><span class="line">          log.error(&quot;SFTP 下载文件超时: &quot; + filePath, e);</span><br><span class="line">          throw new RuntimeException(&quot;SFTP 下载文件超时&quot;, e);</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">          log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">          throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">          executor.shutdown();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>
<p>这段代码可能会导致“管道关闭”问题，主要原因是 ChannelSftp 的连接在任务完成后立即被关闭，而返回的 InputStream 依赖于这个连接。如果在关闭连接后尝试读取 InputStream，就会出现 java.io.IOException: Pipe closed 异常。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><ol>
<li>使用管道流<br>可以使用 PipedInputStream 和 PipedOutputStream 来在任务和主线程之间传递数据，这样可以在任务完成后关闭 ChannelSftp 连接，但仍然能读取数据。</li>
<li>在任务中读取数据<br>在任务中读取数据并将其存储在内存中（例如，使用 ByteArrayOutputStream），然后返回一个新的 InputStream<br>改进代码<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public InputStream downloadFile(String filePath, int operationTimeout) &#123;</span><br><span class="line">    ExecutorService executor = Executors.newSingleThreadExecutor();</span><br><span class="line">    Future&lt;byte[]&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">        ChannelSftp channelSftp = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            channelSftp = setupJsch();</span><br><span class="line">            try (InputStream inputStream = channelSftp.get(filePath);</span><br><span class="line">                 ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) &#123;</span><br><span class="line">                byte[] buffer = new byte[1024];</span><br><span class="line">                int bytesRead;</span><br><span class="line">                while ((bytesRead = inputStream.read(buffer)) != -1) &#123;</span><br><span class="line">                    outputStream.write(buffer, 0, bytesRead);</span><br><span class="line">                &#125;</span><br><span class="line">                return outputStream.toByteArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">            throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (channelSftp != null &amp;&amp; channelSftp.isConnected()) &#123;</span><br><span class="line">                channelSftp.disconnect();</span><br><span class="line">                try &#123;</span><br><span class="line">                    channelSftp.getSession().disconnect();</span><br><span class="line">                &#125; catch (JSchException e) &#123;</span><br><span class="line">                    log.error(&quot;SFTP 会话断开失败&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        byte[] fileData = future.get(operationTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">        return new ByteArrayInputStream(fileData);</span><br><span class="line">    &#125; catch (TimeoutException e) &#123;</span><br><span class="line">        future.cancel(true);</span><br><span class="line">        log.error(&quot;SFTP 下载文件超时: &quot; + filePath, e);</span><br><span class="line">        throw new RuntimeException(&quot;SFTP 下载文件超时&quot;, e);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">        throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-09-10 视频文件合成处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-09-10 09:29:49" itemprop="dateCreated datePublished" datetime="2024-09-10T09:29:49+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-11 14:23:13" itemprop="dateModified" datetime="2024-09-11T14:23:13+08:00">2024-09-11</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有这样一个需求。人工巡检时有巡检轨迹，轨迹上分布了很多摄像头。巡检时每个摄像头都会拍到巡检录像。现在需要把轨迹上所有摄像头录制视频合成一个视频。</p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><p>引入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.bytedeco&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;javacv-platform&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;1.5.6&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.bytedeco&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;javacv&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;1.5.6&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>代码实现  从sftp拿视频, 然后在本地临时存储, 然后合成视频, 然后上传ftp, 返回合成视频地址, 最后删除本地视频文件关闭连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/assembleVideo&quot;)</span><br><span class="line">  public BaseResult assembleVideo(@RequestParam List&lt;String&gt; ftpVideoUrls, @RequestParam(required = false)  Integer cutSecond) &#123;</span><br><span class="line">      List&lt;String&gt; downloadedFilePaths = new ArrayList&lt;&gt;();</span><br><span class="line">      // 从ftp下载视频，然后创建临时文件地址</span><br><span class="line">      log.info(&quot;开始创建临时文件&quot;);</span><br><span class="line">      for (String videoUrl : ftpVideoUrls) &#123;</span><br><span class="line">          InputStream in = fileStorageService.downloadFile(videoUrl);</span><br><span class="line">          if (in == null) &#123;</span><br><span class="line">              log.info(&quot;ftp地址无效。&quot;);</span><br><span class="line">              continue;</span><br><span class="line">          &#125;</span><br><span class="line">          File tempFile = null;</span><br><span class="line">          try &#123;</span><br><span class="line">              tempFile  = File.createTempFile(&quot;video_&quot; + UUID.randomUUID().toString(), &quot;.mp4&quot;);</span><br><span class="line">              tempFile.deleteOnExit(); // JVM退出时删除临时文件</span><br><span class="line">              try (FileOutputStream out = new FileOutputStream(tempFile)) &#123;</span><br><span class="line">                  byte[] buffer = new byte[1024];</span><br><span class="line">                  int bytesRead;</span><br><span class="line">                  while ((bytesRead = in.read(buffer)) != -1) &#123;</span><br><span class="line">                      out.write(buffer, 0, bytesRead);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              downloadedFilePaths.add(tempFile.getAbsolutePath());</span><br><span class="line">          &#125; catch (IOException e) &#123;</span><br><span class="line">              if (tempFile != null &amp;&amp; tempFile.exists()) &#123;</span><br><span class="line">                  try &#123;</span><br><span class="line">                      Files.delete(tempFile.toPath());</span><br><span class="line">                  &#125; catch (IOException ex) &#123;</span><br><span class="line">                      log.error(&quot;程序发生异常，删除临时文件失败&quot; + ex.getMessage());</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              throw new BusinessRuntimeException(&quot;Failed to download and save video: &quot; + videoUrl, e);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      log.info(&quot;创建临时文件结束&quot;);</span><br><span class="line">      String outputPath;</span><br><span class="line">      File concatenatedVideoFile = null;</span><br><span class="line">      String fileUrl = &quot;&quot;;</span><br><span class="line">      try &#123;</span><br><span class="line">          String tempDir = System.getProperty(&quot;java.io.tmpdir&quot;);</span><br><span class="line">          outputPath = tempDir + File.separator + &quot;concatenated_&quot; + UUID.randomUUID().toString() + &quot;.mp4&quot;;</span><br><span class="line">          concatenateVideos(downloadedFilePaths, outputPath, cutSecond);</span><br><span class="line">          concatenatedVideoFile = new File(outputPath);</span><br><span class="line">          String fileName = UUID.fastUUID().toString(true) + &quot;.mp4&quot;;</span><br><span class="line">          log.info(&quot;合成视频大小&quot; + concatenatedVideoFile.length() + &quot;bytes&quot;);</span><br><span class="line">          fileUrl =  fileStorageService.uploadFile(fileName, &quot;cutVideo&quot;, new FileInputStream(concatenatedVideoFile), 120 * 1000L);</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">          log.error(&quot;合成视频失败。&quot; + e.getMessage());</span><br><span class="line">      &#125;  finally &#123;</span><br><span class="line">          // 删除临时文件</span><br><span class="line">          for (String filePath : downloadedFilePaths) &#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                  Files.deleteIfExists(new File(filePath).toPath());</span><br><span class="line">              &#125; catch (IOException e) &#123;</span><br><span class="line">                  log.error(&quot;删除临时文件失败: &quot; + e.getMessage());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          // 删除拼接后的视频文件</span><br><span class="line">          if (concatenatedVideoFile != null &amp;&amp; concatenatedVideoFile.exists()) &#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                  Files.delete(concatenatedVideoFile.toPath());</span><br><span class="line">              &#125; catch (IOException e) &#123;</span><br><span class="line">                  log.error(&quot;删除拼接后的视频文件失败: &quot; + e.getMessage());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      log.info(&quot;合成视频并上传ftp结束.&quot;);</span><br><span class="line">      return BaseResult.success(fileUrl);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-08-26-@async异步失效问题处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-08-26 21:40:06 / 修改时间：21:52:42" itemprop="dateCreated datePublished" datetime="2024-08-26T21:40:06+08:00">2024-08-26</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有这样一个需求 外部调用我们系统接口把巡检任务明细下发。之后，我们需要根据根据巡检任务，去走我们内部一系列复杂流程。得出结果后，调用他们提供的接口把数据返回给他们。因为需要走一系列复杂流程耗时较长。这里采用异步的方式把结果返回给他们。<br>使用@async 注解异步执行复杂逻辑并调用接口返回。发现@async 调用不生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Async(&quot;asyncExecutor&quot;)</span><br><span class="line">private void sendDataToBLD(TaskRequest request, Long id) &#123;</span><br><span class="line">    log.info(&quot;开始异步执行任务发送巡检轨迹图和视频给bld。&quot;);</span><br><span class="line">    if (bldPersonUrl == null || bldPersonUrl.isEmpty()) &#123;</span><br><span class="line">        log.info(&quot;未配置便利店上报人员轨迹图地址&quot;);</span><br><span class="line">        updateStaus(&quot;-1&quot;, id);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        String cadUrl = rfidPointPersonLogMapper.queryCadUrl(request.getParams());</span><br><span class="line">        request.getParams().setInspectionImage(getBase64Pic(cadUrl));</span><br><span class="line">        // 设置视频地址</span><br><span class="line">        setVideoUrl(request);</span><br><span class="line">        Map&lt;String, String&gt; header = new HashMap&lt;&gt;();</span><br><span class="line">        header.put(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">        HttpUtil.createPost(bldPersonUrl).addHeaders(header).body(JSONUtil.toJsonStr(request)).execute().body();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;上报便利店轨迹和视频失败.&quot;, e);</span><br><span class="line">        updateStaus(&quot;-1&quot;, id);</span><br><span class="line">    &#125;</span><br><span class="line">    updateStaus(&quot;1&quot;, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p> @Async 注解的方法必须是 public 的, 必须保证实现类的可见性，因为 Spring 的代理机制（无论是基于 JDK 动态代理还是 CGLIB 代理）都只能拦截 public 方法。 private 改成 public.s</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">夏远建</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">夏远建</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">146k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:26</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'JM04yDYxfC7OBdEVFPgjYe82-gzGzoHsz',
      appKey     : 'N0ThHHvSUDiGsV5vHwy9wavK',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-CN' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
