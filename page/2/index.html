<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.html"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="夏远建的博客">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="夏远建的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="夏远建">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>夏远建的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">夏远建的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">不积硅步，无以至千里；不积小流，无以成江海</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-10-19-使用多线程调用外部接口缺陷处理 -Use multithreading to invoke external interface defect handling</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-10-19 21:55:19" itemprop="dateCreated datePublished" datetime="2024-10-19T21:55:19+08:00">2024-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-10-26 20:01:57" itemprop="dateModified" datetime="2024-10-26T20:01:57+08:00">2024-10-26</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/10/19/2024-10-19-%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%8E%A5%E5%8F%A3%E7%BC%BA%E9%99%B7%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述-Problem-description"><a href="#问题描述-Problem-description" class="headerlink" title="问题描述 - Problem description"></a>问题描述 - Problem description</h3><p>调用外部系统同步机架下的u位数据，发现有的u位数据没有正常同步过来。 -The external system is called to synchronize the U-bit data under the rack, and the existing U-bit data is not synchronized properly.<br>因为u位数据数量很多，对方系统没有提供批量同步的接口。所以使用多线程的方法调用。下面是调用代码。-Because of the large amount of U-bit data, the other system does not provide an interface for batch synchronization. So use multi-threaded method calls. Here’s the call code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">log.info(&quot;开始同步机架U位数据....&quot;);</span><br><span class="line">     long startTime = System.currentTimeMillis();</span><br><span class="line">     List&lt;RoomckCloudResCabinet&gt; roomckCloudResCabinets = roomckCloudResCabinetMapper.queryAllCloudData();</span><br><span class="line">     log.info(&quot;机架数据数量：&quot; + roomckCloudResCabinets.size());</span><br><span class="line">     if (roomckCloudResCabinets.isEmpty()) &#123;</span><br><span class="line">         return;</span><br><span class="line">     &#125;</span><br><span class="line">     String nonce = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span><br><span class="line">     Map&lt;String, String&gt; header = GetCloudSignUtil.getHeaders(ak,</span><br><span class="line">            sk, System.currentTimeMillis(), nonce);</span><br><span class="line">     String url = cloudServerUrl + ApiSkAKConst.UCABINETDATA_SYNC_URL;</span><br><span class="line">     CommonRequestDTO commonRequestDTO = new CommonRequestDTO();</span><br><span class="line">     List&lt;CompletableFuture&gt; futureList = new ArrayList&lt;&gt;();</span><br><span class="line">     for (RoomckCloudResCabinet roomckCloudResCabinet : roomckCloudResCabinets) &#123;</span><br><span class="line">         CompletableFuture future = CompletableFuture.runAsync(new Runnable() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public void run() &#123;</span><br><span class="line">                 try &#123;</span><br><span class="line">                     commonRequestDTO.setId(roomckCloudResCabinet.getId());</span><br><span class="line">                     String response = HttpUtil.createPost(url).addHeaders(header).body(JSONUtil.toJsonStr(commonRequestDTO)).execute().body();</span><br><span class="line">                     CabinetUResultDTO  result =  JSON.parseObject(response).toJavaObject(CabinetUResultDTO.class);</span><br><span class="line">                     if (result.getResultObject() == null || result.getResultObject().isEmpty()) &#123;</span><br><span class="line">                         return;</span><br><span class="line">                     &#125;</span><br><span class="line">                     if (result.getResultObject().get(0) == null) &#123;</span><br><span class="line">                         return;</span><br><span class="line">                     &#125;</span><br><span class="line">                     List&lt;UCabinetDataDTO&gt; uCabinetDataDTOList = JSONArray.parseArray(result.getResultObject().get(0).getList().toString(), UCabinetDataDTO.class);</span><br><span class="line">                     List&lt;RoomckCloudResU&gt; roomckCloudResUS = new ArrayList&lt;&gt;();</span><br><span class="line">                     if (uCabinetDataDTOList != null) &#123;</span><br><span class="line">                         for (UCabinetDataDTO uCabinetDataDTO : uCabinetDataDTOList) &#123;</span><br><span class="line">                             RoomckCloudResU roomckResU = new RoomckCloudResU();</span><br><span class="line">                             transferUCabinet(roomckCloudResCabinet, uCabinetDataDTO, roomckResU);</span><br><span class="line">                             roomckCloudResUS.add(roomckResU);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                     roomckCloudUsCabinetMapper.insertOrUpdateBatch(roomckCloudResUS);</span><br><span class="line">                 &#125;</span><br><span class="line">                 catch (Exception e) &#123;</span><br><span class="line">                     log.info(&quot;机架id为&quot; + roomckCloudResCabinet.getId() + &quot;下的U位数据同步失败。&quot;);</span><br><span class="line">                     log.error(e.getMessage(), e);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;, ThreadUtils.ioPool);</span><br><span class="line">         futureList.add(future);</span><br><span class="line">     &#125;</span><br><span class="line">     CompletableFuture.allOf(futureList.toArray(new CompletableFuture[0])).join();</span><br><span class="line">     log.info(&quot;机架U位同步完成.耗时&quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="问题分析-problem-analysis"><a href="#问题分析-problem-analysis" class="headerlink" title="问题分析 - problem analysis"></a>问题分析 - problem analysis</h3><ol>
<li>我犯了一个很基础的错误，commonRequestDTO 是多线程共享的，赋值的时候没有加锁，导致传的参数可能被其他线程覆盖了。所以有的u位数据没有同步。 - I made a very basic mistake, commonRequestDTO is shared by multiple threads, and there is no lock when assigning the value, which causes the passed parameters to be overridden by other threads. So some U-bit data is not synchronized</li>
<li>分析日志发现。当接口多次调用的时候。对方服务器接口会返回500，拒绝服务. 代码没有重试机制，缺少健壮性。</li>
</ol>
<ul>
<li>Analyze log findings. When an interface is called multiple times. The other server interface will return a 500 and refuse service. The code has no retry mechanism and lacks robustness.</li>
</ul>
<ol start="3">
<li>调用外部接口获取密钥的 header 是所有线程共用的。而这个同步数据有点多。大概需要30分钟才能同步完成。而接口的密钥有效性只有2分钟，所以在2分钟之后后面再次调用接口会出现认证失败。</li>
</ol>
<ul>
<li>The header that calls an external interface to obtain a key is shared by all threads. And this synchronization data is a bit much. It takes about 30 minutes to sync. The key validity of the interface is only 2 minutes, so if the API is called again after 2 minutes, the authentication will fail</li>
</ul>
<h3 id="问题解决-problem-solution"><a href="#问题解决-problem-solution" class="headerlink" title="问题解决 - problem solution"></a>问题解决 - problem solution</h3><ol>
<li>对commonRequestDTO.setId(roomckCloudResCabinet.getId()); 这行代码加锁 -Lock the line of code: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> synchronized (commonRequestDTO) &#123;</span><br><span class="line">                    commonRequestDTO.setId(roomckCloudResCabinet.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>代码加上重试机制 优化后代码 - Code with retry mechanism, optimized code as follows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">@Async</span><br><span class="line">@Scheduled(cron = &quot;$&#123;task.ucabinetdata.sync.cron&#125;&quot;)</span><br><span class="line">@SchedulerLock(name = &quot;CloudCt_task.ucabinetdata.sync&quot;, lockAtLeastForString = &quot;PT30M&quot;, lockAtMostForString = &quot;PT60M&quot;)</span><br><span class="line">public void syncStation() &#123;</span><br><span class="line">    log.info(&quot;开始同步机架U位数据....&quot;);</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line">    List&lt;RoomckCloudResCabinet&gt; roomckCloudResCabinets = roomckCloudResCabinetMapper.queryAllCloudData();</span><br><span class="line">    log.info(&quot;机架数据数量：&quot; + roomckCloudResCabinets.size());</span><br><span class="line">    if (roomckCloudResCabinets.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    String nonce = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span><br><span class="line">    Map&lt;String, String&gt; header = GetCloudSignUtil.getHeaders(ak,</span><br><span class="line">           sk, System.currentTimeMillis(), nonce);</span><br><span class="line">    String url = cloudServerUrl + ApiSkAKConst.UCABINETDATA_SYNC_URL;</span><br><span class="line">    CommonRequestDTO commonRequestDTO = new CommonRequestDTO();</span><br><span class="line">    List&lt;CompletableFuture&gt; futureList = new ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;RoomckCloudResCabinet&gt; failedCabinets = Collections.synchronizedList(new ArrayList&lt;&gt;());</span><br><span class="line">    for (RoomckCloudResCabinet roomckCloudResCabinet : roomckCloudResCabinets) &#123;</span><br><span class="line">        CompletableFuture future = CompletableFuture.runAsync(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    synchronized (commonRequestDTO) &#123;</span><br><span class="line">                        commonRequestDTO.setId(roomckCloudResCabinet.getId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    String response = HttpUtil.createPost(url).addHeaders(header).body(JSONUtil.toJsonStr(commonRequestDTO)).execute().body();</span><br><span class="line">                    CabinetUResultDTO  result =  JSON.parseObject(response).toJavaObject(CabinetUResultDTO.class);</span><br><span class="line">                    if (result.getResultObject() == null || result.getResultObject().isEmpty()) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (result.getResultObject().get(0) == null) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    List&lt;UCabinetDataDTO&gt; uCabinetDataDTOList = JSONArray.parseArray(result.getResultObject().get(0).getList().toString(), UCabinetDataDTO.class);</span><br><span class="line">                    List&lt;RoomckCloudResU&gt; roomckCloudResUS = new ArrayList&lt;&gt;();</span><br><span class="line">                    if (uCabinetDataDTOList != null) &#123;</span><br><span class="line">                        for (UCabinetDataDTO uCabinetDataDTO : uCabinetDataDTOList) &#123;</span><br><span class="line">                            RoomckCloudResU roomckResU = new RoomckCloudResU();</span><br><span class="line">                            transferUCabinet(roomckCloudResCabinet, uCabinetDataDTO, roomckResU);</span><br><span class="line">                            roomckCloudResUS.add(roomckResU);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    roomckCloudUsCabinetMapper.insertOrUpdateBatch(roomckCloudResUS);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception e) &#123;</span><br><span class="line">                    log.info(&quot;机架id为&quot; + roomckCloudResCabinet.getId() + &quot;下的U位数据同步失败。&quot;);</span><br><span class="line">                    failedCabinets.add(roomckCloudResCabinet);</span><br><span class="line">                    log.error(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, ThreadUtils.ioPool);</span><br><span class="line">        futureList.add(future);</span><br><span class="line">    &#125;</span><br><span class="line">    CompletableFuture.allOf(futureList.toArray(new CompletableFuture[0])).join();</span><br><span class="line">    log.info(&quot;机架U位同步完成.耗时&quot; + (System.currentTimeMillis() - startTime) + &quot;ms&quot;);</span><br><span class="line">    // 处理失败的请求</span><br><span class="line">    if (!failedCabinets.isEmpty()) &#123;</span><br><span class="line">        log.info(&quot;有&quot; + failedCabinets.size() + &quot;个机架调用接口失败。开始发起重试&quot;);</span><br><span class="line">        retryFailedRequests(failedCabinets, header, url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">private void retryFailedRequests(List&lt;RoomckCloudResCabinet&gt; failedCabinets, Map&lt;String, String&gt; header, String url) &#123;</span><br><span class="line">    CommonRequestDTO commonRequestDTO = new CommonRequestDTO();</span><br><span class="line">    for (RoomckCloudResCabinet cabinet : failedCabinets) &#123;</span><br><span class="line">        int retryCount = 0;</span><br><span class="line">        boolean success = false;</span><br><span class="line">        while (retryCount &lt; MAX_RETRIES &amp;&amp; !success) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                synchronized (commonRequestDTO) &#123;</span><br><span class="line">                    commonRequestDTO.setId(cabinet.getId());</span><br><span class="line">                &#125;</span><br><span class="line">                String response = HttpUtil.createPost(url)</span><br><span class="line">                        .addHeaders(header)</span><br><span class="line">                        .body(JSONUtil.toJsonStr(commonRequestDTO))</span><br><span class="line">                        .execute().body();</span><br><span class="line">                CabinetUResultDTO result = JSON.parseObject(response).toJavaObject(CabinetUResultDTO.class);</span><br><span class="line">                if (result.getResultObject() == null || result.getResultObject().isEmpty()) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if (result.getResultObject().get(0) == null) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;UCabinetDataDTO&gt; uCabinetDataDTOList = JSONArray.parseArray(</span><br><span class="line">                        result.getResultObject().get(0).getList().toString(), UCabinetDataDTO.class);</span><br><span class="line">                List&lt;RoomckCloudResU&gt; roomckCloudResUS = new ArrayList&lt;&gt;();</span><br><span class="line">                if (uCabinetDataDTOList != null) &#123;</span><br><span class="line">                    for (UCabinetDataDTO uCabinetDataDTO : uCabinetDataDTOList) &#123;</span><br><span class="line">                        RoomckCloudResU roomckResU = new RoomckCloudResU();</span><br><span class="line">                        transferUCabinet(cabinet, uCabinetDataDTO, roomckResU);</span><br><span class="line">                        roomckCloudResUS.add(roomckResU);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                roomckCloudUsCabinetMapper.insertOrUpdateBatch(roomckCloudResUS);</span><br><span class="line">                success = true; // 如果成功则退出重试循环</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                retryCount++;</span><br><span class="line">                log.info(&quot;机架id为&quot; + cabinet.getId() + &quot;的重试第&quot; + retryCount + &quot;次失败。&quot;);</span><br><span class="line">                log.error(e.getMessage(), e);</span><br><span class="line">                if (retryCount &gt;= MAX_RETRIES) &#123;</span><br><span class="line">                    log.info(&quot;机架id为&quot; + cabinet.getId() + &quot;的重试已达到最大次数。&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>每次调用接口的时候都重新获取密钥 把 Map&lt;String, String&gt; header &#x3D; GetCloudSignUtil.getHeaders(ak,sk, System.currentTimeMillis(), nonce); 放到方法内部。</li>
</ol>
<ul>
<li>Each time the interface is called, the key is re-obtained, and the <code>Map&lt;String, String&gt; header = GetCloudSignUtil.getHeaders(ak, sk, System.currentTimeMillis(), nonce);</code> is placed within the method.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-10-07-手机app端登录不上,session获取不到,问题处理 - The mobile app cannot be logged in, the session cannot be obtained, and the problem is handled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-10-07 16:43:34" itemprop="dateCreated datePublished" datetime="2024-10-07T16:43:34+08:00">2024-10-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-10-19 22:01:48" itemprop="dateModified" datetime="2024-10-19T22:01:48+08:00">2024-10-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/10/07/2024-10-07-%E6%89%8B%E6%9C%BAapp%E7%AB%AF%E7%99%BB%E5%BD%95%E4%B8%8D%E4%B8%8Asession%E8%8E%B7%E5%8F%96%E4%B8%8D%E5%88%B0%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述-Problem-description"><a href="#问题描述-Problem-description" class="headerlink" title="问题描述 - Problem description"></a>问题描述 - Problem description</h3><p>web 能正常登录机房系统。 手机app却不能正常登录 - Web can log in to the computer room system normally. The mobile app cannot be logged in normally</p>
<h2 id="以下是报错日志-The-following-is-the-error-log报错代码-error-code通过日志分析。发现当app登录时，一直获取不到对应的sessionID-但是很奇怪的是app端和web端后台都是访问同一个接口。web-端能正常登录，可以获取到session，app端却不能。使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。-因为app端配置了反向代理。访问的登录接口为-http-172-21-72-176-8311-roomck-app-aiFactoryServer-system-session-verificationCode，它带了-roomck-app-前缀。-而服务器设置了-Path-aiFactoryServer-HttpOnly-路径必须以-aiFactoryServer开头才会携带cookie-所以app一直不能正常登录系统。"><a href="#以下是报错日志-The-following-is-the-error-log报错代码-error-code通过日志分析。发现当app登录时，一直获取不到对应的sessionID-但是很奇怪的是app端和web端后台都是访问同一个接口。web-端能正常登录，可以获取到session，app端却不能。使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。-因为app端配置了反向代理。访问的登录接口为-http-172-21-72-176-8311-roomck-app-aiFactoryServer-system-session-verificationCode，它带了-roomck-app-前缀。-而服务器设置了-Path-aiFactoryServer-HttpOnly-路径必须以-aiFactoryServer开头才会携带cookie-所以app一直不能正常登录系统。" class="headerlink" title="以下是报错日志 -  The following is the error log报错代码 - error code通过日志分析。发现当app登录时，一直获取不到对应的sessionID. 但是很奇怪的是app端和web端后台都是访问同一个接口。web 端能正常登录，可以获取到session，app端却不能。使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。 因为app端配置了反向代理。访问的登录接口为 http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode，它带了 &#x2F;roomck-app 前缀。 而服务器设置了 Path&#x3D;&#x2F;aiFactoryServer; HttpOnly 路径必须以&#x2F;aiFactoryServer开头才会携带cookie,所以app一直不能正常登录系统。"></a>以下是报错日志 -  The following is the error log<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2024-10-07 15:33:03.366  INFO 19 --- [nio-7106-exec-3] .a.a.s.s.FormLoginUsernamePasswordFilter : requestSessionId= null</span><br><span class="line">2024-10-07 15:33:03.366  INFO 19 --- [nio-7106-exec-3] .a.a.s.s.FormLoginUsernamePasswordFilter : session.getId()= BECF178C43BE3DD1B060A3775EE5E0F5</span><br><span class="line">2024-10-07 15:33:03.366  INFO 19 --- [nio-7106-exec-3] .a.a.s.s.FormLoginUsernamePasswordFilter : session.getId()= BECF178C43BE3DD1B060A3775EE5E0F5</span><br><span class="line">2024-10-07 15:33:03.367 ERROR 19 --- [nio-7106-exec-3] c.i.a.c.e.h.C.doFilter() Line: 38        : CommonExceptionHandlerFilter拦截异常null</span><br><span class="line">java.lang.NullPointerException: null</span><br><span class="line">        at com.iwhalecloud.aiFactory.auth.server.security.FormLoginUsernamePasswordFilter.checkVerificationCode(FormLoginUsernamePasswordFilter.java:737) ~[common-auth-server-1.0.jar!/:na]</span><br><span class="line">        at com.iwhalecloud.aiFactory.auth.server.security.FormLoginUsernamePasswordFilter.attemptAuthentication(FormLoginUsernamePasswordFilter.java:396) ~[common-auth-server-1.0.jar!/:na]</span><br><span class="line">        at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:231) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:221) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:361) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line">        at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93) ~[spring-security-web-5.8.12.jar!/:5.8.12]</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>报错代码 - error code<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String verificationCode = portalSessionUtil.getLocalSessionAttr(session.getId(), &quot;VERIFICATION_CODE&quot;).toString();</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>通过日志分析。发现当app登录时，一直获取不到对应的sessionID. 但是很奇怪的是app端和web端后台都是访问同一个接口。web 端能正常登录，可以获取到session，app端却不能。<br>使用postMan不断调试。终于发现问题所在。使用app端访问接口是不会设置cookie的。 因为app端配置了反向代理。访问的登录接口为 <a target="_blank" rel="noopener" href="http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode%EF%BC%8C%E5%AE%83%E5%B8%A6%E4%BA%86">http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode，它带了</a> &#x2F;roomck-app 前缀。 而服务器设置了 Path&#x3D;&#x2F;aiFactoryServer; HttpOnly 路径必须以&#x2F;aiFactoryServer开头才会携带cookie,所以app一直不能正常登录系统。</h2><p>Through log analysis, it was found that when the app logs in, it consistently fails to obtain the corresponding sessionID. However, it is quite strange that both the app side and the web backend are accessing the same interface. The web side can log in normally and obtain a session, but the app side cannot.</p>
<p>Continuously debugged using postMan. Finally, the problem was found. When accessing the interface from the app end, cookies are not set. This is because the app end is configured with a reverse proxy. The login interface accessed is <a target="_blank" rel="noopener" href="http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode">http://172.21.72.176:8311/roomck-app/aiFactoryServer/system/session/verificationCode</a>, which includes the &#x2F;roomck-app prefix. However, the server is set to Path&#x3D;&#x2F;aiFactoryServer; HttpOnly, and the path must start with &#x2F;aiFactoryServer to carry the cookie. Therefore, the app has been unable to log in to the system normally.</p>
<h3 id="解决办法-Solution-Method"><a href="#解决办法-Solution-Method" class="headerlink" title="解决办法 - Solution Method"></a>解决办法 - Solution Method</h3><p>为了不增加安全风险，前端调整访问路径。并在nginx 增加对应的代理规则 - In order not to increase security risks, the front-end adjusts the access path and add the corresponding proxy rule to nginx</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-09-10 sftp上传下载问题处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-09-10 16:42:15" itemprop="dateCreated datePublished" datetime="2024-09-10T16:42:15+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-11 11:32:42" itemprop="dateModified" datetime="2024-09-11T11:32:42+08:00">2024-09-11</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/09/10/2024-09-10-sftp%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="sftp-下载调试"><a href="#sftp-下载调试" class="headerlink" title="sftp 下载调试"></a>sftp 下载调试</h3><p>公司sftp服务器因安全策略本地无法直接连接。不好调试问题。本机windows安装sftp服务.<br>下载freeSSHd 作为sftp 服务端，下载FileZilla 做客户端。<br>调试上传功能无问题，下载的时候出现 java.io.IOException: Pipe closed 下载文件内容无法正常下载<br>下载代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public InputStream downloadFile(String filePath, int operationTimeout) &#123;</span><br><span class="line">      ExecutorService executor = Executors.newSingleThreadExecutor();</span><br><span class="line">      Future&lt;InputStream&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">          ChannelSftp channelSftp = null;</span><br><span class="line">          try &#123;</span><br><span class="line">              channelSftp = setupJsch();</span><br><span class="line">              return channelSftp.get(filePath);</span><br><span class="line">          &#125; catch (Exception e) &#123;</span><br><span class="line">              log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">              throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">          &#125; finally &#123;</span><br><span class="line">              if (channelSftp != null &amp;&amp; channelSftp.isConnected()) &#123;</span><br><span class="line">                  channelSftp.disconnect();</span><br><span class="line">                  try &#123;</span><br><span class="line">                      channelSftp.getSession().disconnect();</span><br><span class="line">                  &#125; catch (JSchException e) &#123;</span><br><span class="line">                      log.error(&quot;SFTP 会话断开失败&quot;, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      try &#123;</span><br><span class="line">          return future.get(operationTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">      &#125; catch (TimeoutException e) &#123;</span><br><span class="line">          future.cancel(true);</span><br><span class="line">          log.error(&quot;SFTP 下载文件超时: &quot; + filePath, e);</span><br><span class="line">          throw new RuntimeException(&quot;SFTP 下载文件超时&quot;, e);</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">          log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">          throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">          executor.shutdown();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>
<p>这段代码可能会导致“管道关闭”问题，主要原因是 ChannelSftp 的连接在任务完成后立即被关闭，而返回的 InputStream 依赖于这个连接。如果在关闭连接后尝试读取 InputStream，就会出现 java.io.IOException: Pipe closed 异常。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><ol>
<li>使用管道流<br>可以使用 PipedInputStream 和 PipedOutputStream 来在任务和主线程之间传递数据，这样可以在任务完成后关闭 ChannelSftp 连接，但仍然能读取数据。</li>
<li>在任务中读取数据<br>在任务中读取数据并将其存储在内存中（例如，使用 ByteArrayOutputStream），然后返回一个新的 InputStream<br>改进代码<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public InputStream downloadFile(String filePath, int operationTimeout) &#123;</span><br><span class="line">    ExecutorService executor = Executors.newSingleThreadExecutor();</span><br><span class="line">    Future&lt;byte[]&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">        ChannelSftp channelSftp = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            channelSftp = setupJsch();</span><br><span class="line">            try (InputStream inputStream = channelSftp.get(filePath);</span><br><span class="line">                 ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) &#123;</span><br><span class="line">                byte[] buffer = new byte[1024];</span><br><span class="line">                int bytesRead;</span><br><span class="line">                while ((bytesRead = inputStream.read(buffer)) != -1) &#123;</span><br><span class="line">                    outputStream.write(buffer, 0, bytesRead);</span><br><span class="line">                &#125;</span><br><span class="line">                return outputStream.toByteArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">            throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (channelSftp != null &amp;&amp; channelSftp.isConnected()) &#123;</span><br><span class="line">                channelSftp.disconnect();</span><br><span class="line">                try &#123;</span><br><span class="line">                    channelSftp.getSession().disconnect();</span><br><span class="line">                &#125; catch (JSchException e) &#123;</span><br><span class="line">                    log.error(&quot;SFTP 会话断开失败&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        byte[] fileData = future.get(operationTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">        return new ByteArrayInputStream(fileData);</span><br><span class="line">    &#125; catch (TimeoutException e) &#123;</span><br><span class="line">        future.cancel(true);</span><br><span class="line">        log.error(&quot;SFTP 下载文件超时: &quot; + filePath, e);</span><br><span class="line">        throw new RuntimeException(&quot;SFTP 下载文件超时&quot;, e);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;SFTP 下载文件失败: &quot; + filePath, e);</span><br><span class="line">        throw new RuntimeException(&quot;SFTP 下载文件失败&quot;, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-09-10 视频文件合成处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-09-10 09:29:49" itemprop="dateCreated datePublished" datetime="2024-09-10T09:29:49+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-11 14:23:13" itemprop="dateModified" datetime="2024-09-11T14:23:13+08:00">2024-09-11</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/09/10/2024-09-10-%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E5%90%88%E6%88%90%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有这样一个需求。人工巡检时有巡检轨迹，轨迹上分布了很多摄像头。巡检时每个摄像头都会拍到巡检录像。现在需要把轨迹上所有摄像头录制视频合成一个视频。</p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><p>引入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.bytedeco&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;javacv-platform&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;1.5.6&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.bytedeco&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;javacv&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;1.5.6&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>代码实现  从sftp拿视频, 然后在本地临时存储, 然后合成视频, 然后上传ftp, 返回合成视频地址, 最后删除本地视频文件关闭连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/assembleVideo&quot;)</span><br><span class="line">  public BaseResult assembleVideo(@RequestParam List&lt;String&gt; ftpVideoUrls, @RequestParam(required = false)  Integer cutSecond) &#123;</span><br><span class="line">      List&lt;String&gt; downloadedFilePaths = new ArrayList&lt;&gt;();</span><br><span class="line">      // 从ftp下载视频，然后创建临时文件地址</span><br><span class="line">      log.info(&quot;开始创建临时文件&quot;);</span><br><span class="line">      for (String videoUrl : ftpVideoUrls) &#123;</span><br><span class="line">          InputStream in = fileStorageService.downloadFile(videoUrl);</span><br><span class="line">          if (in == null) &#123;</span><br><span class="line">              log.info(&quot;ftp地址无效。&quot;);</span><br><span class="line">              continue;</span><br><span class="line">          &#125;</span><br><span class="line">          File tempFile = null;</span><br><span class="line">          try &#123;</span><br><span class="line">              tempFile  = File.createTempFile(&quot;video_&quot; + UUID.randomUUID().toString(), &quot;.mp4&quot;);</span><br><span class="line">              tempFile.deleteOnExit(); // JVM退出时删除临时文件</span><br><span class="line">              try (FileOutputStream out = new FileOutputStream(tempFile)) &#123;</span><br><span class="line">                  byte[] buffer = new byte[1024];</span><br><span class="line">                  int bytesRead;</span><br><span class="line">                  while ((bytesRead = in.read(buffer)) != -1) &#123;</span><br><span class="line">                      out.write(buffer, 0, bytesRead);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              downloadedFilePaths.add(tempFile.getAbsolutePath());</span><br><span class="line">          &#125; catch (IOException e) &#123;</span><br><span class="line">              if (tempFile != null &amp;&amp; tempFile.exists()) &#123;</span><br><span class="line">                  try &#123;</span><br><span class="line">                      Files.delete(tempFile.toPath());</span><br><span class="line">                  &#125; catch (IOException ex) &#123;</span><br><span class="line">                      log.error(&quot;程序发生异常，删除临时文件失败&quot; + ex.getMessage());</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              throw new BusinessRuntimeException(&quot;Failed to download and save video: &quot; + videoUrl, e);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      log.info(&quot;创建临时文件结束&quot;);</span><br><span class="line">      String outputPath;</span><br><span class="line">      File concatenatedVideoFile = null;</span><br><span class="line">      String fileUrl = &quot;&quot;;</span><br><span class="line">      try &#123;</span><br><span class="line">          String tempDir = System.getProperty(&quot;java.io.tmpdir&quot;);</span><br><span class="line">          outputPath = tempDir + File.separator + &quot;concatenated_&quot; + UUID.randomUUID().toString() + &quot;.mp4&quot;;</span><br><span class="line">          concatenateVideos(downloadedFilePaths, outputPath, cutSecond);</span><br><span class="line">          concatenatedVideoFile = new File(outputPath);</span><br><span class="line">          String fileName = UUID.fastUUID().toString(true) + &quot;.mp4&quot;;</span><br><span class="line">          log.info(&quot;合成视频大小&quot; + concatenatedVideoFile.length() + &quot;bytes&quot;);</span><br><span class="line">          fileUrl =  fileStorageService.uploadFile(fileName, &quot;cutVideo&quot;, new FileInputStream(concatenatedVideoFile), 120 * 1000L);</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">          log.error(&quot;合成视频失败。&quot; + e.getMessage());</span><br><span class="line">      &#125;  finally &#123;</span><br><span class="line">          // 删除临时文件</span><br><span class="line">          for (String filePath : downloadedFilePaths) &#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                  Files.deleteIfExists(new File(filePath).toPath());</span><br><span class="line">              &#125; catch (IOException e) &#123;</span><br><span class="line">                  log.error(&quot;删除临时文件失败: &quot; + e.getMessage());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          // 删除拼接后的视频文件</span><br><span class="line">          if (concatenatedVideoFile != null &amp;&amp; concatenatedVideoFile.exists()) &#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                  Files.delete(concatenatedVideoFile.toPath());</span><br><span class="line">              &#125; catch (IOException e) &#123;</span><br><span class="line">                  log.error(&quot;删除拼接后的视频文件失败: &quot; + e.getMessage());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      log.info(&quot;合成视频并上传ftp结束.&quot;);</span><br><span class="line">      return BaseResult.success(fileUrl);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-08-26-@async异步失效问题处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-08-26 21:40:06 / 修改时间：21:52:42" itemprop="dateCreated datePublished" datetime="2024-08-26T21:40:06+08:00">2024-08-26</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/08/26/2024-08-26-async%E5%BC%82%E6%AD%A5%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有这样一个需求 外部调用我们系统接口把巡检任务明细下发。之后，我们需要根据根据巡检任务，去走我们内部一系列复杂流程。得出结果后，调用他们提供的接口把数据返回给他们。因为需要走一系列复杂流程耗时较长。这里采用异步的方式把结果返回给他们。<br>使用@async 注解异步执行复杂逻辑并调用接口返回。发现@async 调用不生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Async(&quot;asyncExecutor&quot;)</span><br><span class="line">private void sendDataToBLD(TaskRequest request, Long id) &#123;</span><br><span class="line">    log.info(&quot;开始异步执行任务发送巡检轨迹图和视频给bld。&quot;);</span><br><span class="line">    if (bldPersonUrl == null || bldPersonUrl.isEmpty()) &#123;</span><br><span class="line">        log.info(&quot;未配置便利店上报人员轨迹图地址&quot;);</span><br><span class="line">        updateStaus(&quot;-1&quot;, id);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        String cadUrl = rfidPointPersonLogMapper.queryCadUrl(request.getParams());</span><br><span class="line">        request.getParams().setInspectionImage(getBase64Pic(cadUrl));</span><br><span class="line">        // 设置视频地址</span><br><span class="line">        setVideoUrl(request);</span><br><span class="line">        Map&lt;String, String&gt; header = new HashMap&lt;&gt;();</span><br><span class="line">        header.put(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">        HttpUtil.createPost(bldPersonUrl).addHeaders(header).body(JSONUtil.toJsonStr(request)).execute().body();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;上报便利店轨迹和视频失败.&quot;, e);</span><br><span class="line">        updateStaus(&quot;-1&quot;, id);</span><br><span class="line">    &#125;</span><br><span class="line">    updateStaus(&quot;1&quot;, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p> @Async 注解的方法必须是 public 的, 必须保证实现类的可见性，因为 Spring 的代理机制（无论是基于 JDK 动态代理还是 CGLIB 代理）都只能拦截 public 方法。 private 改成 public.s</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-08-26-导出多sheet处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-08-26 20:11:31 / 修改时间：21:13:22" itemprop="dateCreated datePublished" datetime="2024-08-26T20:11:31+08:00">2024-08-26</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>233</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>使用hutool   writer.setSheet(sheetName);<br>导出文件多sheet文件时，多出现一个空白sheet页。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>当执行 ExcelWriter writer &#x3D; ExcelUtil.getWriter(true) 时会自动创建一个sheet页，所以如何不需要自动创建的，需要先把<br>自动生成的sheet删除。增加以下一行代码.之后在创建自己自定义的sheet页。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writer.getWorkbook().removeSheetAt(0);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-07-29-安全问题处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-07-29 14:07:47 / 修改时间：14:45:12" itemprop="dateCreated datePublished" datetime="2024-07-29T14:07:47+08:00">2024-07-29</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>内审稽核上传功能点处存在仟意文件上传漏洞，通过抓取数据包修改内容的方式，可绕过前端上传文件类型检测。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>增加后台文件类型校验，采用白名单方式校验。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public final class FileTypeWhitelist &#123;</span><br><span class="line">    private  FileTypeWhitelist() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    // 允许的 MIME 类型</span><br><span class="line">    private static final List&lt;String&gt; ALLOWED_MIME_TYPES = Arrays.asList(</span><br><span class="line">            &quot;image/jpeg&quot;, // jpg, jpeg</span><br><span class="line">            &quot;image/png&quot;, // png</span><br><span class="line">            &quot;application/pdf&quot;, // pdf</span><br><span class="line">            &quot;application/msword&quot;, // doc</span><br><span class="line">            &quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;, // docx</span><br><span class="line">            &quot;application/vnd.ms-excel&quot;, // xls</span><br><span class="line">            &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; // xlsx</span><br><span class="line">    );</span><br><span class="line">    // 允许的文件扩展名</span><br><span class="line">    private static final Set&lt;String&gt; ALLOWED_EXTENSIONS = new HashSet&lt;&gt;(Arrays.asList(</span><br><span class="line">            &quot;jpg&quot;,</span><br><span class="line">            &quot;jpeg&quot;,</span><br><span class="line">            &quot;png&quot;,</span><br><span class="line">            &quot;pdf&quot;,</span><br><span class="line">            &quot;doc&quot;,</span><br><span class="line">            &quot;docx&quot;,</span><br><span class="line">            &quot;xls&quot;,</span><br><span class="line">            &quot;xlsx&quot;</span><br><span class="line">    ));</span><br><span class="line">    /**</span><br><span class="line">     * 检查 MIME 类型是否在白名单中</span><br><span class="line">     * @param mimeType MIME 类型</span><br><span class="line">     * @return 如果在白名单中返回 true，否则返回 false</span><br><span class="line">     */</span><br><span class="line">    public static boolean isAllowedMimeType(String mimeType) &#123;</span><br><span class="line">        return ALLOWED_MIME_TYPES.contains(mimeType);</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 检查文件扩展名是否在白名单中</span><br><span class="line">     * @param fileName 文件名</span><br><span class="line">     * @return 如果在白名单中返回 true，否则返回 false</span><br><span class="line">     */</span><br><span class="line">    public static boolean isAllowedExtension(String fileName) &#123;</span><br><span class="line">        String extension = getFileExtension(fileName);</span><br><span class="line">        return ALLOWED_EXTENSIONS.contains(extension.toLowerCase());</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 获取文件的扩展名</span><br><span class="line">     * @param fileName 文件名</span><br><span class="line">     * @return 文件扩展名</span><br><span class="line">     */</span><br><span class="line">    private static String getFileExtension(String fileName) &#123;</span><br><span class="line">        if (fileName == null || fileName.lastIndexOf(&#x27;.&#x27;) == -1) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;) + 1);</span><br><span class="line">    &#125;</span><br><span class="line">    public static boolean checkFiles(MultipartFile[] files) &#123;</span><br><span class="line">        for (MultipartFile file : files) &#123;</span><br><span class="line">            String mimeType = file.getContentType();</span><br><span class="line">            String fileName = file.getOriginalFilename();</span><br><span class="line">            if (!isAllowedMimeType(mimeType) || !isAllowedExtension(fileName)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/" class="post-title-link" itemprop="url">2024-07-29-bug修复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-07-29 11:07:40 / 修改时间：11:13:45" itemprop="dateCreated datePublished" datetime="2024-07-29T11:07:40+08:00">2024-07-29</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>山西出入申请单调用门户接口获取审批人信息，获取不全。<br>问题代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;UserInfoDto&gt; filterManagerOrg(List&lt;UserInfoDto&gt; userInfoDtos, UniformRequest param) &#123;</span><br><span class="line">    if (CollUtil.isNotEmpty(param.getManageOrgIds())) &#123;</span><br><span class="line">        List&lt;Long&gt; orgIdList = param.getManageOrgIds();</span><br><span class="line">        userInfoDtos = userInfoDtos.stream().filter(a -&gt; &#123;</span><br><span class="line">            String manageOrgIds = a.getOrgIdsStr();</span><br><span class="line">            if (StrUtil.isNotBlank(manageOrgIds)) &#123;</span><br><span class="line">                List&lt;Long&gt; orgIds = Arrays.stream(manageOrgIds.split(&quot;,&quot;)).map(Long::parseLong).collect(Collectors.toList());</span><br><span class="line">                for (Long mgorgId : orgIdList) &#123;</span><br><span class="line">                    Organization organization = organizationService.qryOrganizationByOrgId(mgorgId);</span><br><span class="line">                    if (StringUtil.isNotEmpty(organization.getPathCode())) &#123;</span><br><span class="line">                        List&lt;Long&gt; mgorgIds = Arrays.stream(organization.getPathCode().split(&quot;,&quot;)).map(Long::parseLong).collect(Collectors.toList());</span><br><span class="line">                        orgIds.retainAll(mgorgIds);</span><br><span class="line">                        if (CollUtil.isNotEmpty(orgIds)) &#123;</span><br><span class="line">                            return true;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    return userInfoDtos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>orgIds.retainAll(mgorgIds); 会修改原始orgIds。导致影响for循环后面的过滤逻辑。从而使得部分数据被过滤掉。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>在每次需要使用 retainAll 方法时创建一个新的 orgIds 列表的副本。<br>改成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; originalOrgIds = Arrays.stream(manageOrgIds.split(&quot;,&quot;))</span><br><span class="line">                                             .map(Long::parseLong)</span><br><span class="line">                                             .collect(Collectors.toList());</span><br><span class="line">           for (Long mgorgId : orgIdList) &#123;</span><br><span class="line">               Organization organization = organizationService.qryOrganizationByOrgId(mgorgId);</span><br><span class="line">               if (StringUtil.isNotEmpty(organization.getPathCode())) &#123;</span><br><span class="line">                   List&lt;Long&gt; mgorgIds = Arrays.stream(organization.getPathCode().split(&quot;,&quot;))</span><br><span class="line">                                               .map(Long::parseLong)</span><br><span class="line">                                               .collect(Collectors.toList());</span><br><span class="line">                   // 创建 orgIds 的副本</span><br><span class="line">                   List&lt;Long&gt; orgIds = new ArrayList&lt;&gt;(originalOrgIds);</span><br><span class="line">                   // 保留 orgIds 和 mgorgIds 中的公共元素</span><br><span class="line">                   orgIds.retainAll(mgorgIds);</span><br><span class="line">                   if (CollUtil.isNotEmpty(orgIds)) &#123;</span><br><span class="line">                       return true;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/" class="post-title-link" itemprop="url">2024-06-27-bug修复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-27 14:31:31 / 修改时间：14:40:22" itemprop="dateCreated datePublished" datetime="2024-06-27T14:31:31+08:00">2024-06-27</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>708</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>mybatis 里判断等于条件，if条件始终不生效。<br>问题代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;if test=&quot;compType != null and (compType == &#x27;3&#x27; or compType == &#x27;4&#x27;)&quot;&gt;</span><br><span class="line">            AND comp_type = #&#123;compType&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;compType == &#x27;2&#x27; &quot;&gt;</span><br><span class="line">            AND comp_type is null</span><br><span class="line"> &lt;/if&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>mybtis 判定不等于test使用双引号，里面参数使用单引号；但是<br>当使用&#x3D;&#x3D;的时候，需要test外层使用 ‘’单引号，里面的参数使用 “”双引号<br>改成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;if test=&quot;beginDate != null and endDate != null&quot;&gt;</span><br><span class="line">           AND update_time BETWEEN #&#123;beginDate&#125; AND #&#123;endDate&#125;</span><br><span class="line">       &lt;/if&gt;</span><br><span class="line">       &lt;if test=&#x27;compType != null and (compType == &quot;3&quot; or compType == &quot;4&quot;)&#x27;&gt;</span><br><span class="line">           AND comp_type = #&#123;compType&#125;</span><br><span class="line">       &lt;/if&gt;</span><br><span class="line">       &lt;if test=&#x27;compType == &quot;2&quot;&#x27;&gt;</span><br><span class="line">           AND comp_type is null</span><br><span class="line">       &lt;/if&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">2024-06-27-sql性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-27 10:38:34 / 修改时间：14:33:48" itemprop="dateCreated datePublished" datetime="2024-06-27T10:38:34+08:00">2024-06-27</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>功能优化。菜单路径：巡检任务查询</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>定位到以下sql </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">        select</span><br><span class="line">	rct.id,</span><br><span class="line">	rct.task_num as taskNum,</span><br><span class="line">	rct.plan_id as planId,</span><br><span class="line">	rct.plan_name as planName,</span><br><span class="line">	rct.exec_hour as execHour,</span><br><span class="line">	rct.task_start_time as taskStartTime,</span><br><span class="line">	rct.task_end_time as taskEndTime,</span><br><span class="line">	rct.task_s_start_time as taskSStartTime,</span><br><span class="line">	rct.task_s_end_time as taskSEndTime,</span><br><span class="line">	rct.task_desc as taskDesc,</span><br><span class="line">	rct.is_trun as isTrun,</span><br><span class="line">	rct.create_time as createTime,</span><br><span class="line">	rct.task_state as taskState,</span><br><span class="line">	rcm.org_id as orgId,</span><br><span class="line">	(case</span><br><span class="line">		when rct.task_state = 1003</span><br><span class="line">		and rct.task_s_end_time &gt; rct.task_end_time then 1</span><br><span class="line">		when rct.task_state in(1001, 1002)</span><br><span class="line">		and now() &gt; rct.task_end_time then 1</span><br><span class="line">		else 0</span><br><span class="line">	end ) as isOverTime,</span><br><span class="line">	GROUP_CONCAT(distinct rctu.execution_user_name) as planUserName,</span><br><span class="line">	GROUP_CONCAT(distinct rcti.submit_user) as executionUserName,</span><br><span class="line">	GROUP_CONCAT(rctu.execution_user) as executionUserId,</span><br><span class="line">	rcm.mould_typle as mouldTyple,</span><br><span class="line">	rct.approve_user as approveUser,</span><br><span class="line">	rct.approve_user_name as approveUserName ,</span><br><span class="line">	rct.comments,</span><br><span class="line">	rct.approve_time as approveTime,</span><br><span class="line">	rct.is_incident as isIncident ,</span><br><span class="line">	rcp.group_id as groupId</span><br><span class="line">from</span><br><span class="line">	roomck_ck_task rct</span><br><span class="line">inner join roomck_ck_plan rcp on</span><br><span class="line">	rct.plan_id = rcp.id</span><br><span class="line">inner join roomck_ck_mould rcm on</span><br><span class="line">	rct.mould_id = rcm.id</span><br><span class="line">left join roomck_ck_task_user rctu on</span><br><span class="line">	rct.id = rctu.task_id</span><br><span class="line">	and rctu.data_state = &#x27;00A&#x27;</span><br><span class="line">inner join roomck_ck_task_item rcti on</span><br><span class="line">	rct.id = rcti.task_id</span><br><span class="line">inner join roomck_organization ro on</span><br><span class="line">	ro.org_id = rcm.org_id</span><br><span class="line">where</span><br><span class="line">	rct.ck_type = &#x27;1&#x27;</span><br><span class="line">group by</span><br><span class="line">	rct.id</span><br><span class="line">order by</span><br><span class="line">	taskStartTime desc</span><br><span class="line">limit 100</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ol>
<li>发现roomck_ck_task_item 的task_id是字符串类型，rct.id 是bigint 类型。索引失效。</li>
<li>发现GROUP_CONCAT连接后的字符串长度超过限制后，会被截断</li>
</ol>
<h3 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h3><ol>
<li>把roomck_ck_task_item的task_id改成bigint类型。</li>
<li>GROUP_CONCAT 的实现逻辑转成在程序里实现<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE roomck_ck_task_item MODIFY COLUMN task_id BIGINT NULL COMMENT &#x27;任务ID&#x27;;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="优化结果"><a href="#优化结果" class="headerlink" title="优化结果"></a>优化结果</h3><p>查询优化到 3 秒 以内</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">夏远建</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">夏远建</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">181k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:29</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'JM04yDYxfC7OBdEVFPgjYe82-gzGzoHsz',
      appKey     : 'N0ThHHvSUDiGsV5vHwy9wavK',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-CN' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
