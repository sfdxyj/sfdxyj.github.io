<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.html"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="夏远建的博客">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="夏远建的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="夏远建">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>夏远建的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">夏远建的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">不积硅步，无以至千里；不积小流，无以成江海</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-08-26-导出多sheet处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-08-26 20:11:31 / 修改时间：21:13:22" itemprop="dateCreated datePublished" datetime="2024-08-26T20:11:31+08:00">2024-08-26</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/08/26/2024-08-26-%E5%AF%BC%E5%87%BA%E5%A4%9Asheet%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>233</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>使用hutool   writer.setSheet(sheetName);<br>导出文件多sheet文件时，多出现一个空白sheet页。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>当执行 ExcelWriter writer &#x3D; ExcelUtil.getWriter(true) 时会自动创建一个sheet页，所以如何不需要自动创建的，需要先把<br>自动生成的sheet删除。增加以下一行代码.之后在创建自己自定义的sheet页。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writer.getWorkbook().removeSheetAt(0);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">2024-07-29-安全问题处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-07-29 14:07:47 / 修改时间：14:45:12" itemprop="dateCreated datePublished" datetime="2024-07-29T14:07:47+08:00">2024-07-29</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/29/2024-07-29-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>内审稽核上传功能点处存在仟意文件上传漏洞，通过抓取数据包修改内容的方式，可绕过前端上传文件类型检测。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>增加后台文件类型校验，采用白名单方式校验。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public final class FileTypeWhitelist &#123;</span><br><span class="line">    private  FileTypeWhitelist() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    // 允许的 MIME 类型</span><br><span class="line">    private static final List&lt;String&gt; ALLOWED_MIME_TYPES = Arrays.asList(</span><br><span class="line">            &quot;image/jpeg&quot;, // jpg, jpeg</span><br><span class="line">            &quot;image/png&quot;, // png</span><br><span class="line">            &quot;application/pdf&quot;, // pdf</span><br><span class="line">            &quot;application/msword&quot;, // doc</span><br><span class="line">            &quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;, // docx</span><br><span class="line">            &quot;application/vnd.ms-excel&quot;, // xls</span><br><span class="line">            &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot; // xlsx</span><br><span class="line">    );</span><br><span class="line">    // 允许的文件扩展名</span><br><span class="line">    private static final Set&lt;String&gt; ALLOWED_EXTENSIONS = new HashSet&lt;&gt;(Arrays.asList(</span><br><span class="line">            &quot;jpg&quot;,</span><br><span class="line">            &quot;jpeg&quot;,</span><br><span class="line">            &quot;png&quot;,</span><br><span class="line">            &quot;pdf&quot;,</span><br><span class="line">            &quot;doc&quot;,</span><br><span class="line">            &quot;docx&quot;,</span><br><span class="line">            &quot;xls&quot;,</span><br><span class="line">            &quot;xlsx&quot;</span><br><span class="line">    ));</span><br><span class="line">    /**</span><br><span class="line">     * 检查 MIME 类型是否在白名单中</span><br><span class="line">     * @param mimeType MIME 类型</span><br><span class="line">     * @return 如果在白名单中返回 true，否则返回 false</span><br><span class="line">     */</span><br><span class="line">    public static boolean isAllowedMimeType(String mimeType) &#123;</span><br><span class="line">        return ALLOWED_MIME_TYPES.contains(mimeType);</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 检查文件扩展名是否在白名单中</span><br><span class="line">     * @param fileName 文件名</span><br><span class="line">     * @return 如果在白名单中返回 true，否则返回 false</span><br><span class="line">     */</span><br><span class="line">    public static boolean isAllowedExtension(String fileName) &#123;</span><br><span class="line">        String extension = getFileExtension(fileName);</span><br><span class="line">        return ALLOWED_EXTENSIONS.contains(extension.toLowerCase());</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 获取文件的扩展名</span><br><span class="line">     * @param fileName 文件名</span><br><span class="line">     * @return 文件扩展名</span><br><span class="line">     */</span><br><span class="line">    private static String getFileExtension(String fileName) &#123;</span><br><span class="line">        if (fileName == null || fileName.lastIndexOf(&#x27;.&#x27;) == -1) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return fileName.substring(fileName.lastIndexOf(&#x27;.&#x27;) + 1);</span><br><span class="line">    &#125;</span><br><span class="line">    public static boolean checkFiles(MultipartFile[] files) &#123;</span><br><span class="line">        for (MultipartFile file : files) &#123;</span><br><span class="line">            String mimeType = file.getContentType();</span><br><span class="line">            String fileName = file.getOriginalFilename();</span><br><span class="line">            if (!isAllowedMimeType(mimeType) || !isAllowedExtension(fileName)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/" class="post-title-link" itemprop="url">2024-07-29-bug修复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-07-29 11:07:40 / 修改时间：11:13:45" itemprop="dateCreated datePublished" datetime="2024-07-29T11:07:40+08:00">2024-07-29</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/29/2024-07-29-bug%E4%BF%AE%E5%A4%8D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>山西出入申请单调用门户接口获取审批人信息，获取不全。<br>问题代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;UserInfoDto&gt; filterManagerOrg(List&lt;UserInfoDto&gt; userInfoDtos, UniformRequest param) &#123;</span><br><span class="line">    if (CollUtil.isNotEmpty(param.getManageOrgIds())) &#123;</span><br><span class="line">        List&lt;Long&gt; orgIdList = param.getManageOrgIds();</span><br><span class="line">        userInfoDtos = userInfoDtos.stream().filter(a -&gt; &#123;</span><br><span class="line">            String manageOrgIds = a.getOrgIdsStr();</span><br><span class="line">            if (StrUtil.isNotBlank(manageOrgIds)) &#123;</span><br><span class="line">                List&lt;Long&gt; orgIds = Arrays.stream(manageOrgIds.split(&quot;,&quot;)).map(Long::parseLong).collect(Collectors.toList());</span><br><span class="line">                for (Long mgorgId : orgIdList) &#123;</span><br><span class="line">                    Organization organization = organizationService.qryOrganizationByOrgId(mgorgId);</span><br><span class="line">                    if (StringUtil.isNotEmpty(organization.getPathCode())) &#123;</span><br><span class="line">                        List&lt;Long&gt; mgorgIds = Arrays.stream(organization.getPathCode().split(&quot;,&quot;)).map(Long::parseLong).collect(Collectors.toList());</span><br><span class="line">                        orgIds.retainAll(mgorgIds);</span><br><span class="line">                        if (CollUtil.isNotEmpty(orgIds)) &#123;</span><br><span class="line">                            return true;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    return userInfoDtos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>orgIds.retainAll(mgorgIds); 会修改原始orgIds。导致影响for循环后面的过滤逻辑。从而使得部分数据被过滤掉。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>在每次需要使用 retainAll 方法时创建一个新的 orgIds 列表的副本。<br>改成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; originalOrgIds = Arrays.stream(manageOrgIds.split(&quot;,&quot;))</span><br><span class="line">                                             .map(Long::parseLong)</span><br><span class="line">                                             .collect(Collectors.toList());</span><br><span class="line">           for (Long mgorgId : orgIdList) &#123;</span><br><span class="line">               Organization organization = organizationService.qryOrganizationByOrgId(mgorgId);</span><br><span class="line">               if (StringUtil.isNotEmpty(organization.getPathCode())) &#123;</span><br><span class="line">                   List&lt;Long&gt; mgorgIds = Arrays.stream(organization.getPathCode().split(&quot;,&quot;))</span><br><span class="line">                                               .map(Long::parseLong)</span><br><span class="line">                                               .collect(Collectors.toList());</span><br><span class="line">                   // 创建 orgIds 的副本</span><br><span class="line">                   List&lt;Long&gt; orgIds = new ArrayList&lt;&gt;(originalOrgIds);</span><br><span class="line">                   // 保留 orgIds 和 mgorgIds 中的公共元素</span><br><span class="line">                   orgIds.retainAll(mgorgIds);</span><br><span class="line">                   if (CollUtil.isNotEmpty(orgIds)) &#123;</span><br><span class="line">                       return true;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/" class="post-title-link" itemprop="url">2024-06-27-bug修复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-27 14:31:31 / 修改时间：14:40:22" itemprop="dateCreated datePublished" datetime="2024-06-27T14:31:31+08:00">2024-06-27</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/27/2024-06-27-bug%E4%BF%AE%E5%A4%8D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>708</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>mybatis 里判断等于条件，if条件始终不生效。<br>问题代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;if test=&quot;compType != null and (compType == &#x27;3&#x27; or compType == &#x27;4&#x27;)&quot;&gt;</span><br><span class="line">            AND comp_type = #&#123;compType&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;compType == &#x27;2&#x27; &quot;&gt;</span><br><span class="line">            AND comp_type is null</span><br><span class="line"> &lt;/if&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>mybtis 判定不等于test使用双引号，里面参数使用单引号；但是<br>当使用&#x3D;&#x3D;的时候，需要test外层使用 ‘’单引号，里面的参数使用 “”双引号<br>改成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;if test=&quot;beginDate != null and endDate != null&quot;&gt;</span><br><span class="line">           AND update_time BETWEEN #&#123;beginDate&#125; AND #&#123;endDate&#125;</span><br><span class="line">       &lt;/if&gt;</span><br><span class="line">       &lt;if test=&#x27;compType != null and (compType == &quot;3&quot; or compType == &quot;4&quot;)&#x27;&gt;</span><br><span class="line">           AND comp_type = #&#123;compType&#125;</span><br><span class="line">       &lt;/if&gt;</span><br><span class="line">       &lt;if test=&#x27;compType == &quot;2&quot;&#x27;&gt;</span><br><span class="line">           AND comp_type is null</span><br><span class="line">       &lt;/if&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">2024-06-27-sql性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-27 10:38:34 / 修改时间：14:33:48" itemprop="dateCreated datePublished" datetime="2024-06-27T10:38:34+08:00">2024-06-27</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/27/2024-06-27-sql%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>功能优化。菜单路径：巡检任务查询</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>定位到以下sql </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">        select</span><br><span class="line">	rct.id,</span><br><span class="line">	rct.task_num as taskNum,</span><br><span class="line">	rct.plan_id as planId,</span><br><span class="line">	rct.plan_name as planName,</span><br><span class="line">	rct.exec_hour as execHour,</span><br><span class="line">	rct.task_start_time as taskStartTime,</span><br><span class="line">	rct.task_end_time as taskEndTime,</span><br><span class="line">	rct.task_s_start_time as taskSStartTime,</span><br><span class="line">	rct.task_s_end_time as taskSEndTime,</span><br><span class="line">	rct.task_desc as taskDesc,</span><br><span class="line">	rct.is_trun as isTrun,</span><br><span class="line">	rct.create_time as createTime,</span><br><span class="line">	rct.task_state as taskState,</span><br><span class="line">	rcm.org_id as orgId,</span><br><span class="line">	(case</span><br><span class="line">		when rct.task_state = 1003</span><br><span class="line">		and rct.task_s_end_time &gt; rct.task_end_time then 1</span><br><span class="line">		when rct.task_state in(1001, 1002)</span><br><span class="line">		and now() &gt; rct.task_end_time then 1</span><br><span class="line">		else 0</span><br><span class="line">	end ) as isOverTime,</span><br><span class="line">	GROUP_CONCAT(distinct rctu.execution_user_name) as planUserName,</span><br><span class="line">	GROUP_CONCAT(distinct rcti.submit_user) as executionUserName,</span><br><span class="line">	GROUP_CONCAT(rctu.execution_user) as executionUserId,</span><br><span class="line">	rcm.mould_typle as mouldTyple,</span><br><span class="line">	rct.approve_user as approveUser,</span><br><span class="line">	rct.approve_user_name as approveUserName ,</span><br><span class="line">	rct.comments,</span><br><span class="line">	rct.approve_time as approveTime,</span><br><span class="line">	rct.is_incident as isIncident ,</span><br><span class="line">	rcp.group_id as groupId</span><br><span class="line">from</span><br><span class="line">	roomck_ck_task rct</span><br><span class="line">inner join roomck_ck_plan rcp on</span><br><span class="line">	rct.plan_id = rcp.id</span><br><span class="line">inner join roomck_ck_mould rcm on</span><br><span class="line">	rct.mould_id = rcm.id</span><br><span class="line">left join roomck_ck_task_user rctu on</span><br><span class="line">	rct.id = rctu.task_id</span><br><span class="line">	and rctu.data_state = &#x27;00A&#x27;</span><br><span class="line">inner join roomck_ck_task_item rcti on</span><br><span class="line">	rct.id = rcti.task_id</span><br><span class="line">inner join roomck_organization ro on</span><br><span class="line">	ro.org_id = rcm.org_id</span><br><span class="line">where</span><br><span class="line">	rct.ck_type = &#x27;1&#x27;</span><br><span class="line">group by</span><br><span class="line">	rct.id</span><br><span class="line">order by</span><br><span class="line">	taskStartTime desc</span><br><span class="line">limit 100</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ol>
<li>发现roomck_ck_task_item 的task_id是字符串类型，rct.id 是bigint 类型。索引失效。</li>
<li>发现GROUP_CONCAT连接后的字符串长度超过限制后，会被截断</li>
</ol>
<h3 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h3><ol>
<li>把roomck_ck_task_item的task_id改成bigint类型。</li>
<li>GROUP_CONCAT 的实现逻辑转成在程序里实现<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE roomck_ck_task_item MODIFY COLUMN task_id BIGINT NULL COMMENT &#x27;任务ID&#x27;;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="优化结果"><a href="#优化结果" class="headerlink" title="优化结果"></a>优化结果</h3><p>查询优化到 3 秒 以内</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">2024-05-29-运用策略模式与范型编程实现功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-05-29 19:31:26 / 修改时间：20:03:34" itemprop="dateCreated datePublished" datetime="2024-05-29T19:31:26+08:00">2024-05-29</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h3><p>需要实现根据不同部门发送不同的消息模板。每个消息模板内取数方式都不一样。另外需要根据不同模板下载不同的文件。<br>实现不同的下载方法。</p>
<h3 id="技术实现"><a href="#技术实现" class="headerlink" title="技术实现"></a>技术实现</h3><ol>
<li>对于不同的消息模板，使用FreeMaker模板引擎编写不同的消息模板。</li>
<li>运用策略模式，实现不同的消息发送服务。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 注入实现StrategyMethodService接口的实现类</span><br><span class="line"> @Autowired</span><br><span class="line"> Map&lt;String, StrategyMethodService&gt; stringStrategyMethodServiceMap = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> public StrategyMethodService getStrategyService(String serviceCode) &#123;</span><br><span class="line">     StrategyMethodService strategyService = stringStrategyMethodServiceMap.get(serviceCode);</span><br><span class="line">     if (strategyService == null) &#123;</span><br><span class="line">         throw new BusinessRuntimeException(&quot;13000003&quot;);</span><br><span class="line">     &#125;</span><br><span class="line">     return strategyService;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li>使用范型编程编写通用的下载方法，提升代码灵活性与复用性。T extends excelData 不仅仅可以限定参数的范围。方法内部还可以使用父类的属性和方法。十分灵活和方便。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 不同消息实现类调用该方法</span><br><span class="line">private &lt;T extends excelData&gt; List&lt;T&gt; getExcelData(Condition data, Class&lt;T&gt; tClass)  &#123;</span><br><span class="line">    // 在这个方法内部，可以使用excelData的一些属性和方法，</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="范型限制类型"><a href="#范型限制类型" class="headerlink" title="范型限制类型"></a>范型限制类型</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">T extends SomeClass: 这种限制要求范型参数必须是某个类（或其子类）的类型。例如，T extends Number 要求范型参数必须是 Number 类（或其子类）的类型。</span><br><span class="line"></span><br><span class="line">T super SomeClass: 这种限制要求范型参数必须是某个类（或其父类）的类型。例如，T super Integer 要求范型参数必须是 Integer 类（或其父类）的类型。</span><br><span class="line"></span><br><span class="line">T extends Interface: 这种限制要求范型参数必须实现某个接口。例如，T extends Comparable 要求范型参数必须实现 Comparable 接口。</span><br><span class="line"></span><br><span class="line">T extends SomeClass &amp; Interface: 这种限制要求范型参数必须是某个类（或其子类）的类型，并且实现了指定的接口。例如，T extends Number &amp; Comparable 要求范型参数必须是 Number 类（或其子类）的类型，并且实现了 Comparable 接口。</span><br><span class="line"></span><br><span class="line">T extends Enum: 这种限制要求范型参数必须是枚举类型。</span><br></pre></td></tr></table></figure>

<h3 id="业务代码实现逻辑"><a href="#业务代码实现逻辑" class="headerlink" title="业务代码实现逻辑"></a>业务代码实现逻辑</h3><p>预警通知逻辑<br>1.扫描应急预警通知单 预警状态为已发布（5），预警性质为初次发布（1）的数据，关联应急事件表，返回所有需要发送的实体信息。<br>2.遍历所有需要发布的实体信息。<br>3.调用防御部署算法入库预估数据，根据事件id过滤，重复的事件只调用一次算法。<br>4.发送预警发布信息。发送信息枚举为0。已经发送过的不在发送。<br>5.遍历需要发送信息的不同部门模版信息服务。根据不同的信息枚举调用不同的消息服务。<br>6.对应消息实现类实现不同模版的取数。实现逻辑， 一进入实现类，首先判定该消息是否已经发送过（查询预警行动分析表）。如果已经发送过。返回消息null; 外部根据返回的信息是否为空，判定是否继续往下执行。如果第一次发送。则走下面逻辑。不同模版取不同的数据。取数完成之后。调用转换业务分析-清单数据的实体类方法。 入库清单数据，注意如果一个部门有多个清单，需要入库多个清单数据。（主要逻辑是取对应业务表的主键id入库。实现下载方法时根据该id关联对应的业务表取数）。主要作用是为了之后下载清单用。取到数据后，把对应的数据塞到模版对应的变量当中，使用的技术是freeMarker. 对应的模版文件在资源文件的templates下。<br>7.实现清单下载。大概框架写好了，只要补充不同的清单数据实现逻辑即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">2024-05-28-智能体相关功能技术实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-05-28 15:11:59 / 修改时间：17:28:53" itemprop="dateCreated datePublished" datetime="2024-05-28T15:11:59+08:00">2024-05-28</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="判断器组件功能"><a href="#判断器组件功能" class="headerlink" title="判断器组件功能"></a>判断器组件功能</h3><h4 id="功能描述："><a href="#功能描述：" class="headerlink" title="功能描述："></a>功能描述：</h4><p>  在智能体编排界面，选择判断器组件。输入表达式。表达式为真走一个流程；为假走另一个流程。<br>表达式是规则表达式； 例如 a &gt; b; a 与 b 分别为编排界面输入的变量名。可能是上游的引用，也可能是赋值。</p>
<h4 id="技术实现："><a href="#技术实现：" class="headerlink" title="技术实现："></a>技术实现：</h4><p>功能实现简单引入com.googlecode.aviator 对表达式进行预处理。由AviatorEvaluator去判断表达器真假</p>
<pre><code>            Expression compiledExp = AviatorEvaluator.compile(exp, true);
            Map&lt;String, Object&gt; env = new HashMap&lt;&gt;(inputs);
            Boolean result = (Boolean) compiledExp.execute(env);
</code></pre>
<p><img src="/../images/judgement.JPG" alt="img">   </p>
<h3 id="迭代器组件功能"><a href="#迭代器组件功能" class="headerlink" title="迭代器组件功能"></a>迭代器组件功能</h3><h4 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h4><p>  把上游传过来的数据根据输入的迭代器表达转换成字符串的形式。上游传过来的数据可能是list, 也有可能是map. 需要根据输入的迭代器表达式输出字符串。如果是list则需要循环遍历出list所有的数据。<br>例子： 迭代器配置: ‘\{\{output.q\}\} &#x3D;哈&#x3D;\{\{output.a\}\}’  |||<br>最终下游大模型节点得到这个字符串：<br>’接口规范1&#x3D;哈&#x3D;问题1|||接口规范2&#x3D;哈&#x3D;问题1|||接口规范3&#x3D;哈&#x3D;问题1|||接口规范4&#x3D;哈&#x3D;问题1|||接口规范5&#x3D;哈&#x3D;问题1‘<br><img src="/../images/iterator.JPG" alt="img"></p>
<h4 id="技术实现"><a href="#技术实现" class="headerlink" title="技术实现"></a>技术实现</h4><ol>
<li>从功能描述可知，第一个.前面的是变量名，需要使用java 正则表达式Pattern，Matcher。把它切割出来。才能得到对应数据。</li>
<li>引入com.google.gson。因为上游传入的参数可能是Map, 也有可能是List. 需要判断传入的数据是哪种类型。gson 提供了api方便我们判断</li>
<li>需要考虑嵌套数据。map 里面某个属性可能还嵌套其他属性。比如输入的表达式可能是 a.b.c 需要取出a的孙子节点c的数据。实现细节， 需要同时使用 com.google.gson 和java 正则表达式实现。</li>
</ol>
<h3 id="数据库组件功能"><a href="#数据库组件功能" class="headerlink" title="数据库组件功能"></a>数据库组件功能</h3><p> 功能描述： 在sql表达框内输入sql。 使用 \{\{\}\}\ 把变量名括起来。只支持查询语句<br> 功能实现比较简单。</p>
<ol>
<li>使用java正则表达式 取出变量名</li>
<li>找到对应变量名 把它替换成？。使用预处理方式执行sql;防止sql 注入。</li>
<li>直接使用jdbc模板类把参数名填充执行sql语句。</li>
</ol>
<h3 id="意图识别功能-（实现的主要是针对excel文档问答场景）"><a href="#意图识别功能-（实现的主要是针对excel文档问答场景）" class="headerlink" title="意图识别功能 （实现的主要是针对excel文档问答场景）"></a>意图识别功能 （实现的主要是针对excel文档问答场景）</h3><h4 id="功能描述-1"><a href="#功能描述-1" class="headerlink" title="功能描述"></a>功能描述</h4><p>  用户输入一个问题，需要去判断这个问题是否存在知识库当中。如果不存在。需要根据问题进行分析。返回3个最可能用户问的问题。后台还会返回转换后的参数交给下游及知识库去精确匹配以提升准确率。</p>
<h4 id="技术实现-1"><a href="#技术实现-1" class="headerlink" title="技术实现"></a>技术实现</h4><p>   完成该功能，需要前置功能: 知识库管理功能，知识构建功能, 术语管理功能。</p>
<ol>
<li>知识库管理功能主要是知识库的权限隔离，增删改查功能。</li>
<li>知识构建主要是把word文档，excel文档进行embedding向量化，存储到向量库（redis集群实现的）和pgsql库。<br>针对excel文档，还需区分实体和概念入术语表。实体是表格里的数据。概念是表头的数据。</li>
<li>术语管理功能。术语的增删改查功能以及同义词的管理功能</li>
<li>界面编排界面，需要指定参数哪个知识库，实体和概念对应的知识库和文件是哪个</li>
</ol>
<h4 id="意图识别实现思路"><a href="#意图识别实现思路" class="headerlink" title="意图识别实现思路"></a>意图识别实现思路</h4><p>  初期实现思路是通过结巴分词对问题进行分词，然后根据分词结果与术语匹配。发现性能很差而且分词不准，并且结巴分词java版已经停止维护。 优化思路是先根据编排界面的查询术语库，根据术语库把问题进行分词。如果问题中包含术语。则把对应包含的术语。区分概念和实体与编排界面上配置的参数一一匹配上。另外如果配置了同义词。还需对问题进行同义词替换。把同义词替换成术语。如果参数一一匹配上了。最终把用户输入的一句话。输出转换成一个Map形式交给下游。里面包含了实体和概念对应所在的文件，知识库。从而使得在知识库进行向量搜索时，大大提升准确率。如果有参数没有匹配上。及说明知识库中不包含用户所在的问题。即要返回3个最可能用户问的问题返回。初期实现思路是，写好提升词；直接把问题和术语直接丢个大模型。让大模型给我生成用户最可能要问的问题。然而，这种实现思路，会出现以下问题，一是性能问题。调用大模型需要时间。二是准确率问题， 不同的大模型用相同的提示词返回答案不一致。往往调试好的提示词，换一个大模型就不行了，导致返回的问题一直回答不了陷入死循环。最后抛弃了这种实现方式。采用的是lucene + hanlp 技术实现。通过hanlp 对问题进行分词。找出最相似的实体， 和最相似的概念。 然后进行拼接问题。缺点是问题模式有点固定。不像大模型返回的问题自然。优点是能确保返回的问题是可以被回答出来的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/" class="post-title-link" itemprop="url">2024-05-09-bug修复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-05-09 09:28:19" itemprop="dateCreated datePublished" datetime="2024-05-09T09:28:19+08:00">2024-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-28 15:02:29" itemprop="dateModified" datetime="2024-05-28T15:02:29+08:00">2024-05-28</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>825</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="bug描述"><a href="#bug描述" class="headerlink" title="bug描述"></a>bug描述</h4><p>使用java 正则表达式处理数据，报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Pattern pattern = Pattern.compile(&quot;\\&#123;\\&#123;(.+?)\\&#125;\\&#125;&quot;);</span><br><span class="line">      Matcher matcher = pattern.matcher(iteratorExp);</span><br><span class="line">      StringBuffer buffer = new StringBuffer();</span><br><span class="line">      while (matcher.find()) &#123;</span><br><span class="line">          String variableName = matcher.group(1); // 获取变量名</span><br><span class="line">          if (jsonElement.isJsonObject()) &#123;</span><br><span class="line">              JsonObject jsonObject = jsonElement.getAsJsonObject();</span><br><span class="line">              JsonElement jsonment = getElementByPath(jsonObject, variableName, key);</span><br><span class="line">              if (jsonment != null) &#123;</span><br><span class="line">                  String escapedText = jsonment.getAsString().replaceAll(&quot;\\$&quot;, &quot;\\\\\\$&quot;).replaceAll(&quot;/&quot;, &quot;\\\\/&quot;);</span><br><span class="line">                  matcher.appendReplacement(buffer, escapedText);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      matcher.appendTail(buffer);</span><br><span class="line">      return buffer.toString();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="bug分析"><a href="#bug分析" class="headerlink" title="bug分析"></a>bug分析</h4><p>.*+?|()[]{}^$\ 在正则表达式中存在特殊含义，当数据存在这些字符时，需要对其转义  Pattern.quote(input);</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ol>
<li>转义x<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String escaped = Pattern.quote(input);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/" class="post-title-link" itemprop="url">2024-04-23-性能优化-csv大文件同步入库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-23 19:48:25" itemprop="dateCreated datePublished" datetime="2024-04-23T19:48:25+08:00">2024-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-24 14:40:56" itemprop="dateModified" datetime="2024-04-24T14:40:56+08:00">2024-04-24</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>738</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>云调资源数据同步。同步设备数据。大csv文件同步数据入库。发生OOM溢出</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>以下为问题代码.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String fullUrl = HttpUtil.urlWithForm(url, paramMap, CharsetUtil.CHARSET_UTF_8, true);</span><br><span class="line">String response  = HttpUtil.createGet(fullUrl).addHeaders(header).execute().body();</span><br><span class="line">List&lt;EquipmentDataDTO&gt; equipmentDataDTOList = transferCsvData(response);</span><br><span class="line">if (equipmentDataDTOList != null) &#123;</span><br><span class="line">    log.info(&quot;同步设备:&quot; + equArray[i] + &quot;,数据大小&quot; + equipmentDataDTOList.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 使用hutool的HttpUtil类去调用外部接口获取设备数据。HttpUtil.createGet(fullUrl).addHeaders(header).execute().body()； .execute()是同步执行的，程序会在发送请求后阻塞，直到收到响应为止。.body()会把数据全部获取完毕，然后一次性塞到内存当中。当数据非常大时，会导致OOM。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>改成异步执行，流式响应体处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream response  = HttpUtil.createGet(fullUrl).addHeaders(header).executeAsync().bodyStream();</span><br></pre></td></tr></table></figure>
<h3 id="优化结果"><a href="#优化结果" class="headerlink" title="优化结果"></a>优化结果</h3><p>对于2G 的csv文件,能正常响应并同步入库</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/" class="post-title-link" itemprop="url">2023-04-07-bug修复-RedisTemplate与StringRedisTemplate</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-07 10:36:09" itemprop="dateCreated datePublished" datetime="2024-04-07T10:36:09+08:00">2024-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-17 17:45:45" itemprop="dateModified" datetime="2024-07-17T17:45:45+08:00">2024-07-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bug-%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">bug 处理</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="bug描述"><a href="#bug描述" class="headerlink" title="bug描述"></a>bug描述</h4><p>报错代码为以下代码。从redis 中获取数据，然后转成UserInfoDTO对象 报错。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (StringUtils.isNotBlank(sessionId)) &#123;</span><br><span class="line">    // 根据sessionId从缓存读取用户信息，存在认为用户已登录，放行</span><br><span class="line">    Object currentUser = cacheClient.hget(SessionConst.USER_SESSIONS_KEY + sessionId, SessionConst.SHARE_CURRENT_USER_KEY);</span><br><span class="line">    System.out.println(currentUser);</span><br><span class="line"></span><br><span class="line">    if (Objects.nonNull(currentUser)) &#123;</span><br><span class="line">        userInfo_ = JSON.parseObject(currentUser.toString(), UserInfoDTO.class);</span><br><span class="line">        System.out.println(userInfo_);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="bug分析"><a href="#bug分析" class="headerlink" title="bug分析"></a>bug分析</h4><p>这段代码是另一个模块复制过来的，在另一个模块不报错。在这个模块就报错了。 经过调试发现从redis 获取的数据json字符串外面还包了一层双引号，如下图。 导致转换对象报错。最后发现两个模块所用的redis模板类不一样导致的。当前模块用的是StringRedisTemplate，另一模块用的RedisTemplate则没有这个问题。原因是在于StringRedisTemplate默认使用的是基于字符串的序列化和反序列化策略，而RedisTemplate使用的是基于Java序列化的策略。这导致了它们在处理特定数据类型时的行为差异。StringRedisTemplate更适合处理简单的字符串或字符串形式的数据，而RedisTemplate由于其默认的序列化策略，更适合处理复杂的Java对象。<br><img src="/../images/2024-4-07-redis.JPG" alt="调试截图"></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ol>
<li>StringRedisTemplate 改成 RedisTemplate</li>
<li>手动处理双引号的情况<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String value = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">if (value != null &amp;&amp; value.startsWith(&quot;\&quot;&quot;) &amp;&amp; value.endsWith(&quot;\&quot;&quot;)) &#123;</span><br><span class="line">    value = value.substring(1, value.length() - 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="RedisTemplate与StringRedisTemplate的区别"><a href="#RedisTemplate与StringRedisTemplate的区别" class="headerlink" title="RedisTemplate与StringRedisTemplate的区别"></a>RedisTemplate与StringRedisTemplate的区别</h4><ol>
<li><p>StringRedisTemplate：专门为字符串操作优化。它默认使用StringRedisSerializer对键和值进行序列化。StringRedisSerializer将Java对象转换成字符串时，如果输入是字符串，它基本上是直接返回这个字符串（不进行额外的处理）。因此，如果你在存储时手动将对象转换为JSON字符串，然后使用StringRedisTemplate存储这个字符串，它实际上是直接存储了这个JSON字符串。在获取这个值时，如果原始数据是带双引号的字符串，这些双引号也会被当作字符串的一部分返回。</p>
</li>
<li><p>RedisTemplate：是更通用的模板，可以用于各种数据类型的Redis操作。它默认使用JdkSerializationRedisSerializer进行序列化，这个序列化器会将Java对象序列化为字节序列，并在这个过程中保留对象的类型信息。当使用RedisTemplate存储数据时，即便是字符串，也会先将其转换成字节序列然后再存储。当从Redis获取数据时，它会将这些字节序列反序列化回原始的Java对象。因此，如果你使用RedisTemplate存储经过JSON序列化的字符串，这个字符串会被作为一个单独的对象处理，而不是简单地作为一个字符串。在反序列化时，RedisTemplate能够正确地处理类型，避免了额外的双引号问题。</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">夏远建</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">夏远建</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">146k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:26</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'JM04yDYxfC7OBdEVFPgjYe82-gzGzoHsz',
      appKey     : 'N0ThHHvSUDiGsV5vHwy9wavK',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-CN' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
