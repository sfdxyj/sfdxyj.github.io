<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.html"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="夏远建的博客">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="夏远建的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="夏远建">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>夏远建的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">夏远建的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">不积硅步，无以至千里；不积小流，无以成江海</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">2024-05-29-运用策略模式与范型编程实现功能</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-05-29 19:31:26 / 修改时间：20:03:34" itemprop="dateCreated datePublished" datetime="2024-05-29T19:31:26+08:00">2024-05-29</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/05/29/2024-05-29-%E8%BF%90%E7%94%A8%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E4%B8%8E%E8%8C%83%E5%9E%8B%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0%E5%8A%9F%E8%83%BD/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h3><p>需要实现根据不同部门发送不同的消息模板。每个消息模板内取数方式都不一样。另外需要根据不同模板下载不同的文件。<br>实现不同的下载方法。</p>
<h3 id="技术实现"><a href="#技术实现" class="headerlink" title="技术实现"></a>技术实现</h3><ol>
<li>对于不同的消息模板，使用FreeMaker模板引擎编写不同的消息模板。</li>
<li>运用策略模式，实现不同的消息发送服务。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 注入实现StrategyMethodService接口的实现类</span><br><span class="line"> @Autowired</span><br><span class="line"> Map&lt;String, StrategyMethodService&gt; stringStrategyMethodServiceMap = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> public StrategyMethodService getStrategyService(String serviceCode) &#123;</span><br><span class="line">     StrategyMethodService strategyService = stringStrategyMethodServiceMap.get(serviceCode);</span><br><span class="line">     if (strategyService == null) &#123;</span><br><span class="line">         throw new BusinessRuntimeException(&quot;13000003&quot;);</span><br><span class="line">     &#125;</span><br><span class="line">     return strategyService;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li>使用范型编程编写通用的下载方法，提升代码灵活性与复用性。T extends excelData 不仅仅可以限定参数的范围。方法内部还可以使用父类的属性和方法。十分灵活和方便。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 不同消息实现类调用该方法</span><br><span class="line">private &lt;T extends excelData&gt; List&lt;T&gt; getExcelData(Condition data, Class&lt;T&gt; tClass)  &#123;</span><br><span class="line">    // 在这个方法内部，可以使用excelData的一些属性和方法，</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="范型限制类型"><a href="#范型限制类型" class="headerlink" title="范型限制类型"></a>范型限制类型</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">T extends SomeClass: 这种限制要求范型参数必须是某个类（或其子类）的类型。例如，T extends Number 要求范型参数必须是 Number 类（或其子类）的类型。</span><br><span class="line"></span><br><span class="line">T super SomeClass: 这种限制要求范型参数必须是某个类（或其父类）的类型。例如，T super Integer 要求范型参数必须是 Integer 类（或其父类）的类型。</span><br><span class="line"></span><br><span class="line">T extends Interface: 这种限制要求范型参数必须实现某个接口。例如，T extends Comparable 要求范型参数必须实现 Comparable 接口。</span><br><span class="line"></span><br><span class="line">T extends SomeClass &amp; Interface: 这种限制要求范型参数必须是某个类（或其子类）的类型，并且实现了指定的接口。例如，T extends Number &amp; Comparable 要求范型参数必须是 Number 类（或其子类）的类型，并且实现了 Comparable 接口。</span><br><span class="line"></span><br><span class="line">T extends Enum: 这种限制要求范型参数必须是枚举类型。</span><br></pre></td></tr></table></figure>

<h3 id="业务代码实现逻辑"><a href="#业务代码实现逻辑" class="headerlink" title="业务代码实现逻辑"></a>业务代码实现逻辑</h3><p>预警通知逻辑<br>1.扫描应急预警通知单 预警状态为已发布（5），预警性质为初次发布（1）的数据，关联应急事件表，返回所有需要发送的实体信息。<br>2.遍历所有需要发布的实体信息。<br>3.调用防御部署算法入库预估数据，根据事件id过滤，重复的事件只调用一次算法。<br>4.发送预警发布信息。发送信息枚举为0。已经发送过的不在发送。<br>5.遍历需要发送信息的不同部门模版信息服务。根据不同的信息枚举调用不同的消息服务。<br>6.对应消息实现类实现不同模版的取数。实现逻辑， 一进入实现类，首先判定该消息是否已经发送过（查询预警行动分析表）。如果已经发送过。返回消息null; 外部根据返回的信息是否为空，判定是否继续往下执行。如果第一次发送。则走下面逻辑。不同模版取不同的数据。取数完成之后。调用转换业务分析-清单数据的实体类方法。 入库清单数据，注意如果一个部门有多个清单，需要入库多个清单数据。（主要逻辑是取对应业务表的主键id入库。实现下载方法时根据该id关联对应的业务表取数）。主要作用是为了之后下载清单用。取到数据后，把对应的数据塞到模版对应的变量当中，使用的技术是freeMarker. 对应的模版文件在资源文件的templates下。<br>7.实现清单下载。大概框架写好了，只要补充不同的清单数据实现逻辑即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">2024-05-28-智能体相关功能技术实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-05-28 15:11:59 / 修改时间：17:28:53" itemprop="dateCreated datePublished" datetime="2024-05-28T15:11:59+08:00">2024-05-28</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/05/28/2024-05-28-%E6%99%BA%E8%83%BD%E4%BD%93%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="判断器组件功能"><a href="#判断器组件功能" class="headerlink" title="判断器组件功能"></a>判断器组件功能</h3><h4 id="功能描述："><a href="#功能描述：" class="headerlink" title="功能描述："></a>功能描述：</h4><p>  在智能体编排界面，选择判断器组件。输入表达式。表达式为真走一个流程；为假走另一个流程。<br>表达式是规则表达式； 例如 a &gt; b; a 与 b 分别为编排界面输入的变量名。可能是上游的引用，也可能是赋值。</p>
<h4 id="技术实现："><a href="#技术实现：" class="headerlink" title="技术实现："></a>技术实现：</h4><p>功能实现简单引入com.googlecode.aviator 对表达式进行预处理。由AviatorEvaluator去判断表达器真假</p>
<pre><code>            Expression compiledExp = AviatorEvaluator.compile(exp, true);
            Map&lt;String, Object&gt; env = new HashMap&lt;&gt;(inputs);
            Boolean result = (Boolean) compiledExp.execute(env);
</code></pre>
<p><img src="/../images/judgement.JPG" alt="img">   </p>
<h3 id="迭代器组件功能"><a href="#迭代器组件功能" class="headerlink" title="迭代器组件功能"></a>迭代器组件功能</h3><h4 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h4><p>  把上游传过来的数据根据输入的迭代器表达转换成字符串的形式。上游传过来的数据可能是list, 也有可能是map. 需要根据输入的迭代器表达式输出字符串。如果是list则需要循环遍历出list所有的数据。<br>例子： 迭代器配置: ‘\{\{output.q\}\} &#x3D;哈&#x3D;\{\{output.a\}\}’  |||<br>最终下游大模型节点得到这个字符串：<br>’接口规范1&#x3D;哈&#x3D;问题1|||接口规范2&#x3D;哈&#x3D;问题1|||接口规范3&#x3D;哈&#x3D;问题1|||接口规范4&#x3D;哈&#x3D;问题1|||接口规范5&#x3D;哈&#x3D;问题1‘<br><img src="/../images/iterator.JPG" alt="img"></p>
<h4 id="技术实现"><a href="#技术实现" class="headerlink" title="技术实现"></a>技术实现</h4><ol>
<li>从功能描述可知，第一个.前面的是变量名，需要使用java 正则表达式Pattern，Matcher。把它切割出来。才能得到对应数据。</li>
<li>引入com.google.gson。因为上游传入的参数可能是Map, 也有可能是List. 需要判断传入的数据是哪种类型。gson 提供了api方便我们判断</li>
<li>需要考虑嵌套数据。map 里面某个属性可能还嵌套其他属性。比如输入的表达式可能是 a.b.c 需要取出a的孙子节点c的数据。实现细节， 需要同时使用 com.google.gson 和java 正则表达式实现。</li>
</ol>
<h3 id="数据库组件功能"><a href="#数据库组件功能" class="headerlink" title="数据库组件功能"></a>数据库组件功能</h3><p> 功能描述： 在sql表达框内输入sql。 使用 \{\{\}\}\ 把变量名括起来。只支持查询语句<br> 功能实现比较简单。</p>
<ol>
<li>使用java正则表达式 取出变量名</li>
<li>找到对应变量名 把它替换成？。使用预处理方式执行sql;防止sql 注入。</li>
<li>直接使用jdbc模板类把参数名填充执行sql语句。</li>
</ol>
<h3 id="意图识别功能-（实现的主要是针对excel文档问答场景）"><a href="#意图识别功能-（实现的主要是针对excel文档问答场景）" class="headerlink" title="意图识别功能 （实现的主要是针对excel文档问答场景）"></a>意图识别功能 （实现的主要是针对excel文档问答场景）</h3><h4 id="功能描述-1"><a href="#功能描述-1" class="headerlink" title="功能描述"></a>功能描述</h4><p>  用户输入一个问题，需要去判断这个问题是否存在知识库当中。如果不存在。需要根据问题进行分析。返回3个最可能用户问的问题。后台还会返回转换后的参数交给下游及知识库去精确匹配以提升准确率。</p>
<h4 id="技术实现-1"><a href="#技术实现-1" class="headerlink" title="技术实现"></a>技术实现</h4><p>   完成该功能，需要前置功能: 知识库管理功能，知识构建功能, 术语管理功能。</p>
<ol>
<li>知识库管理功能主要是知识库的权限隔离，增删改查功能。</li>
<li>知识构建主要是把word文档，excel文档进行embedding向量化，存储到向量库（redis集群实现的）和pgsql库。<br>针对excel文档，还需区分实体和概念入术语表。实体是表格里的数据。概念是表头的数据。</li>
<li>术语管理功能。术语的增删改查功能以及同义词的管理功能</li>
<li>界面编排界面，需要指定参数哪个知识库，实体和概念对应的知识库和文件是哪个</li>
</ol>
<h4 id="意图识别实现思路"><a href="#意图识别实现思路" class="headerlink" title="意图识别实现思路"></a>意图识别实现思路</h4><p>  初期实现思路是通过结巴分词对问题进行分词，然后根据分词结果与术语匹配。发现性能很差而且分词不准，并且结巴分词java版已经停止维护。 优化思路是先根据编排界面的查询术语库，根据术语库把问题进行分词。如果问题中包含术语。则把对应包含的术语。区分概念和实体与编排界面上配置的参数一一匹配上。另外如果配置了同义词。还需对问题进行同义词替换。把同义词替换成术语。如果参数一一匹配上了。最终把用户输入的一句话。输出转换成一个Map形式交给下游。里面包含了实体和概念对应所在的文件，知识库。从而使得在知识库进行向量搜索时，大大提升准确率。如果有参数没有匹配上。及说明知识库中不包含用户所在的问题。即要返回3个最可能用户问的问题返回。初期实现思路是，写好提升词；直接把问题和术语直接丢个大模型。让大模型给我生成用户最可能要问的问题。然而，这种实现思路，会出现以下问题，一是性能问题。调用大模型需要时间。二是准确率问题， 不同的大模型用相同的提示词返回答案不一致。往往调试好的提示词，换一个大模型就不行了，导致返回的问题一直回答不了陷入死循环。最后抛弃了这种实现方式。采用的是lucene + hanlp 技术实现。通过hanlp 对问题进行分词。找出最相似的实体， 和最相似的概念。 然后进行拼接问题。缺点是问题模式有点固定。不像大模型返回的问题自然。优点是能确保返回的问题是可以被回答出来的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/" class="post-title-link" itemprop="url">2024-05-09-bug修复</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-05-09 09:28:19" itemprop="dateCreated datePublished" datetime="2024-05-09T09:28:19+08:00">2024-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-28 15:02:29" itemprop="dateModified" datetime="2024-05-28T15:02:29+08:00">2024-05-28</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/05/09/2024-05-09-bug%E4%BF%AE%E5%A4%8D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>825</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="bug描述"><a href="#bug描述" class="headerlink" title="bug描述"></a>bug描述</h4><p>使用java 正则表达式处理数据，报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Pattern pattern = Pattern.compile(&quot;\\&#123;\\&#123;(.+?)\\&#125;\\&#125;&quot;);</span><br><span class="line">      Matcher matcher = pattern.matcher(iteratorExp);</span><br><span class="line">      StringBuffer buffer = new StringBuffer();</span><br><span class="line">      while (matcher.find()) &#123;</span><br><span class="line">          String variableName = matcher.group(1); // 获取变量名</span><br><span class="line">          if (jsonElement.isJsonObject()) &#123;</span><br><span class="line">              JsonObject jsonObject = jsonElement.getAsJsonObject();</span><br><span class="line">              JsonElement jsonment = getElementByPath(jsonObject, variableName, key);</span><br><span class="line">              if (jsonment != null) &#123;</span><br><span class="line">                  String escapedText = jsonment.getAsString().replaceAll(&quot;\\$&quot;, &quot;\\\\\\$&quot;).replaceAll(&quot;/&quot;, &quot;\\\\/&quot;);</span><br><span class="line">                  matcher.appendReplacement(buffer, escapedText);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      matcher.appendTail(buffer);</span><br><span class="line">      return buffer.toString();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="bug分析"><a href="#bug分析" class="headerlink" title="bug分析"></a>bug分析</h4><p>.*+?|()[]{}^$\ 在正则表达式中存在特殊含义，当数据存在这些字符时，需要对其转义  Pattern.quote(input);</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ol>
<li>转义x<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String escaped = Pattern.quote(input);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/" class="post-title-link" itemprop="url">2024-04-23-性能优化-csv大文件同步入库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-23 19:48:25" itemprop="dateCreated datePublished" datetime="2024-04-23T19:48:25+08:00">2024-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-24 14:40:56" itemprop="dateModified" datetime="2024-04-24T14:40:56+08:00">2024-04-24</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/04/23/2024-04-23-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-csv%E5%A4%A7%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%85%A5%E5%BA%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>738</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>云调资源数据同步。同步设备数据。大csv文件同步数据入库。发生OOM溢出</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>以下为问题代码.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String fullUrl = HttpUtil.urlWithForm(url, paramMap, CharsetUtil.CHARSET_UTF_8, true);</span><br><span class="line">String response  = HttpUtil.createGet(fullUrl).addHeaders(header).execute().body();</span><br><span class="line">List&lt;EquipmentDataDTO&gt; equipmentDataDTOList = transferCsvData(response);</span><br><span class="line">if (equipmentDataDTOList != null) &#123;</span><br><span class="line">    log.info(&quot;同步设备:&quot; + equArray[i] + &quot;,数据大小&quot; + equipmentDataDTOList.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 使用hutool的HttpUtil类去调用外部接口获取设备数据。HttpUtil.createGet(fullUrl).addHeaders(header).execute().body()； .execute()是同步执行的，程序会在发送请求后阻塞，直到收到响应为止。.body()会把数据全部获取完毕，然后一次性塞到内存当中。当数据非常大时，会导致OOM。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>改成异步执行，流式响应体处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream response  = HttpUtil.createGet(fullUrl).addHeaders(header).executeAsync().bodyStream();</span><br></pre></td></tr></table></figure>
<h3 id="优化结果"><a href="#优化结果" class="headerlink" title="优化结果"></a>优化结果</h3><p>对于2G 的csv文件,能正常响应并同步入库</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/" class="post-title-link" itemprop="url">2023-04-07-bug修复-RedisTemplate与StringRedisTemplate</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-07 10:36:09" itemprop="dateCreated datePublished" datetime="2024-04-07T10:36:09+08:00">2024-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-17 17:45:45" itemprop="dateModified" datetime="2024-07-17T17:45:45+08:00">2024-07-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bug-%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">bug 处理</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/04/07/2023-04-07-bug%E4%BF%AE%E5%A4%8D-RedisTemplate-%E4%B8%8E-StringRedisTemplate/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="bug描述"><a href="#bug描述" class="headerlink" title="bug描述"></a>bug描述</h4><p>报错代码为以下代码。从redis 中获取数据，然后转成UserInfoDTO对象 报错。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (StringUtils.isNotBlank(sessionId)) &#123;</span><br><span class="line">    // 根据sessionId从缓存读取用户信息，存在认为用户已登录，放行</span><br><span class="line">    Object currentUser = cacheClient.hget(SessionConst.USER_SESSIONS_KEY + sessionId, SessionConst.SHARE_CURRENT_USER_KEY);</span><br><span class="line">    System.out.println(currentUser);</span><br><span class="line"></span><br><span class="line">    if (Objects.nonNull(currentUser)) &#123;</span><br><span class="line">        userInfo_ = JSON.parseObject(currentUser.toString(), UserInfoDTO.class);</span><br><span class="line">        System.out.println(userInfo_);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="bug分析"><a href="#bug分析" class="headerlink" title="bug分析"></a>bug分析</h4><p>这段代码是另一个模块复制过来的，在另一个模块不报错。在这个模块就报错了。 经过调试发现从redis 获取的数据json字符串外面还包了一层双引号，如下图。 导致转换对象报错。最后发现两个模块所用的redis模板类不一样导致的。当前模块用的是StringRedisTemplate，另一模块用的RedisTemplate则没有这个问题。原因是在于StringRedisTemplate默认使用的是基于字符串的序列化和反序列化策略，而RedisTemplate使用的是基于Java序列化的策略。这导致了它们在处理特定数据类型时的行为差异。StringRedisTemplate更适合处理简单的字符串或字符串形式的数据，而RedisTemplate由于其默认的序列化策略，更适合处理复杂的Java对象。<br><img src="/../images/2024-4-07-redis.JPG" alt="调试截图"></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ol>
<li>StringRedisTemplate 改成 RedisTemplate</li>
<li>手动处理双引号的情况<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String value = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">if (value != null &amp;&amp; value.startsWith(&quot;\&quot;&quot;) &amp;&amp; value.endsWith(&quot;\&quot;&quot;)) &#123;</span><br><span class="line">    value = value.substring(1, value.length() - 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="RedisTemplate与StringRedisTemplate的区别"><a href="#RedisTemplate与StringRedisTemplate的区别" class="headerlink" title="RedisTemplate与StringRedisTemplate的区别"></a>RedisTemplate与StringRedisTemplate的区别</h4><ol>
<li><p>StringRedisTemplate：专门为字符串操作优化。它默认使用StringRedisSerializer对键和值进行序列化。StringRedisSerializer将Java对象转换成字符串时，如果输入是字符串，它基本上是直接返回这个字符串（不进行额外的处理）。因此，如果你在存储时手动将对象转换为JSON字符串，然后使用StringRedisTemplate存储这个字符串，它实际上是直接存储了这个JSON字符串。在获取这个值时，如果原始数据是带双引号的字符串，这些双引号也会被当作字符串的一部分返回。</p>
</li>
<li><p>RedisTemplate：是更通用的模板，可以用于各种数据类型的Redis操作。它默认使用JdkSerializationRedisSerializer进行序列化，这个序列化器会将Java对象序列化为字节序列，并在这个过程中保留对象的类型信息。当使用RedisTemplate存储数据时，即便是字符串，也会先将其转换成字节序列然后再存储。当从Redis获取数据时，它会将这些字节序列反序列化回原始的Java对象。因此，如果你使用RedisTemplate存储经过JSON序列化的字符串，这个字符串会被作为一个单独的对象处理，而不是简单地作为一个字符串。在反序列化时，RedisTemplate能够正确地处理类型，避免了额外的双引号问题。</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/13/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/13/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE/" class="post-title-link" itemprop="url">代码优化建议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-03-13 10:20:15 / 修改时间：10:30:53" itemprop="dateCreated datePublished" datetime="2024-03-13T10:20:15+08:00">2024-03-13</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/03/13/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/03/13/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>88</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>String 转成 Long 类型，建议用 Convert.toDate(stationDataDTO.getGmtUpdated(), null)， 不要用<br>Long.valueOf()。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/04/2023-03-04-bug%E4%BF%AE%E5%A4%8D-mybatis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/04/2023-03-04-bug%E4%BF%AE%E5%A4%8D-mybatis/" class="post-title-link" itemprop="url">2023-03-04-bug修复-mybatis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-04 10:49:34" itemprop="dateCreated datePublished" datetime="2024-03-04T10:49:34+08:00">2024-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-07 11:12:24" itemprop="dateModified" datetime="2024-04-07T11:12:24+08:00">2024-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/bug-%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">bug 处理</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/03/04/2023-03-04-bug%E4%BF%AE%E5%A4%8D-mybatis/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/03/04/2023-03-04-bug%E4%BF%AE%E5%A4%8D-mybatis/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="bug描述"><a href="#bug描述" class="headerlink" title="bug描述"></a>bug描述</h4><p>sql 报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;qryReportList&quot; resultMap=&quot;BaseResultVOMap&quot;&gt;</span><br><span class="line">    SELECT</span><br><span class="line">    t1.id, t1.account_date, t1.city_name, t1.building_name, t1.room_id,</span><br><span class="line">    t1.room_name, t1.device_load, t1.building_load, t1.total_load,</span><br><span class="line">    t1.main_cool_load, t1.load_percent, t1.warn_level, t1.building_space,</span><br><span class="line">    t1.use_profession, t1.room_level_num, t1.station_level_num, t1.total_num,</span><br><span class="line">    t1.total_cool_load, t1.condition_form, t1.supply_form, t1.accept_status,</span><br><span class="line">    t1.create_time, t1.update_time, t1.submit_id,</span><br><span class="line">    t1.submit_name, t1.submit_time, t1.accept_id, t1.accept_name, t1.accept_time, t1.quarter</span><br><span class="line">    FROM zj_air_condition_report t1</span><br><span class="line">    inner JOIN roomck_organization org ON t1.room_id = org.org_id and org.org_level = 12 and org.status_cd = &#x27;00A&#x27;</span><br><span class="line">    &lt;where&gt;</span><br><span class="line">        &lt;if test=&quot;regionToOrgId != null&quot;&gt;</span><br><span class="line">            and FIND_IN_SET(#&#123;regionToOrgId&#125;, org.path_code)</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;startTime != null and startTime != &#x27;&#x27; and endTime != null and endTime != &#x27;&#x27;&quot;&gt;</span><br><span class="line">             t1.account_date between  left(#&#123;startTime&#125;, 10) and left(#&#123;endTime&#125;, 10)</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;orgIdList != null and !orgIdList.isEmpty()&quot;&gt;</span><br><span class="line">            &lt;foreach collection=&quot;orgIdList&quot; item=&quot;orgId&quot; open=&quot; and (&quot; separator=&quot; or &quot; close=&quot;)&quot;&gt;</span><br><span class="line">                find_in_set(#&#123;orgId&#125;, org.path_code)</span><br><span class="line">            &lt;/foreach&gt;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;warnLevelList != null and !warnLevelList.isEmpty()&quot;&gt;</span><br><span class="line">            AND t1.warn_level in</span><br><span class="line">            &lt;foreach collection=&quot;warnLevelList&quot; item=&quot;warnLevel&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">                #&#123;warnLevel&#125;</span><br><span class="line">            &lt;/foreach&gt;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;acceptStatusList != null and !acceptStatusList.isEmpty()&quot;&gt;</span><br><span class="line">            AND t1.accept_status in</span><br><span class="line">            &lt;foreach collection=&quot;acceptStatusList&quot; item=&quot;acceptStatus&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">                #&#123;acceptStatus&#125;</span><br><span class="line">            &lt;/foreach&gt;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;useProfessionList != null and !useProfessionList.isEmpty()&quot;&gt;</span><br><span class="line">            &lt;foreach collection=&quot;useProfessionList&quot; item=&quot;useProfession&quot; open=&quot; and (&quot; separator=&quot; or &quot; close=&quot;)&quot;&gt;</span><br><span class="line">                find_in_set(#&#123;useProfession&#125;, t1.use_profession)</span><br><span class="line">            &lt;/foreach&gt;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h4 id="bug分析"><a href="#bug分析" class="headerlink" title="bug分析"></a>bug分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;if test=&quot;startTime != null and startTime != &#x27;&#x27; and endTime != null and endTime != &#x27;&#x27;&quot;&gt;</span><br><span class="line">             t1.account_date between  left(#&#123;startTime&#125;, 10) and left(#&#123;endTime&#125;, 10)</span><br><span class="line">&lt;/if&gt;</span><br></pre></td></tr></table></figure>
<p>一开始程序没有做这个权限要求，这个条件是后面加上的。然后又放到了where后第一个条件，导致第二个条件忘记加and</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;if test=&quot;regionToOrgId != null&quot;&gt;</span><br><span class="line">    and FIND_IN_SET(#&#123;regionToOrgId&#125;, org.path_code)</span><br><span class="line">&lt;/if&gt;</span><br></pre></td></tr></table></figure>
<p>当regionToOrgId 条件满足时，程序报错 if 里面没有and</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ol>
<li>加上 and 连接</li>
</ol>
<h4 id="反思总结"><a href="#反思总结" class="headerlink" title="反思总结"></a>反思总结</h4><ol>
<li>if标签里面不管是不是第一个条件，都应该加上and。 因为where标签后面的语句以and或者or开头的时候，where标签会自动删除开头的and和or。如果不加上，以后遇到新增需求。一不小心就会犯错。</li>
<li>没有用权限账户进行自测，导致bug泄漏</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/21/kafak-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/21/kafak-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">kafak 参数配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-02-21 09:44:38" itemprop="dateCreated datePublished" datetime="2024-02-21T09:44:38+08:00">2024-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-29 19:56:08" itemprop="dateModified" datetime="2024-02-29T19:56:08+08:00">2024-02-29</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/02/21/kafak-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/02/21/kafak-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>配置信息<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># ⽤于建⽴初始连接的broker地址</span><br><span class="line">spring.kafka.bootstrap-servers=172.21.72.185:9092</span><br><span class="line"># producer key和value的序列化类</span><br><span class="line">spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer</span><br><span class="line"># 默认的批处理数据大小</span><br><span class="line">spring.kafka.producer.batch-size=16384</span><br><span class="line"># 32MB的总发送缓存</span><br><span class="line">spring.kafka.producer.buffer-memory=33554432</span><br><span class="line"># consumer的消费组id</span><br><span class="line">spring.kafka.consumer.group-id=group-alarm</span><br><span class="line"># consumer key和value的序列化类</span><br><span class="line">spring.kafka.consumer.key-serializer=org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">spring.kafka.consumer.value-serializer=org.springframework.kafka.support.serializer.JsonDeserializer</span><br><span class="line"># 是否⾃动提交消费者偏移量</span><br><span class="line">spring.kafka.consumer.enable-auto-commit=false</span><br><span class="line"># listener类型为单条记录single类型（单条消费模式）</span><br><span class="line">spring.kafka.listener.type: single</span><br><span class="line"># offset提交模式为manual_immediate</span><br><span class="line">spring.kafka.listener.ack-mode: manual_immediate</span><br><span class="line"># 每隔100ms向broker提交⼀次偏移量</span><br><span class="line">spring.kafka.consumer.auto-commit-interval=100</span><br><span class="line"># 如果该消费者的偏移量不存在，则⾃动设置为最早的偏移量</span><br><span class="line">spring.kafka.consumer.auto-offset-reset=earliest</span><br><span class="line">#spring.kafka.listener.ack-mode=RECORD</span><br><span class="line"># 会话超时时间</span><br><span class="line">spring.kafka.consumer.session.timeout.ms=30000</span><br><span class="line"># 大消费量</span><br><span class="line">spring.kafka.consumer.max.poll.records=1000</span><br><span class="line"># 如果有多个主题用, 隔开</span><br><span class="line">alarm.topics=roomck</span><br><span class="line">event.topics=roomck</span><br></pre></td></tr></table></figure></li>
<li>相关命令<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">jps -ml   命令查看端口和服务名称</span><br><span class="line"># 根据pid杀死进程</span><br><span class="line">kill -9 PID</span><br><span class="line"></span><br><span class="line">bin/kafka-topics.sh --bootstrap-server  172.21.72.185:9092 --list   -- 查看topic</span><br><span class="line">bin/kafka-topics.sh --bootstrap-server 172.21.72.185:9092 --describe --topic roomck</span><br><span class="line">查看消息</span><br><span class="line">bin/kafka-console-consumer.sh --bootstrap-server 172.21.72.185:9092 --topic roomck--from-beginning </span><br><span class="line"></span><br><span class="line">生产者 生产消息</span><br><span class="line">bin/kafka-console-producer.sh --bootstrap-server 172.21.72.185:9092  --topic roomck</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/31/AES%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/01/31/AES%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">AES加密算法学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-01-31 11:19:18 / 修改时间：14:53:46" itemprop="dateCreated datePublished" datetime="2024-01-31T11:19:18+08:00">2024-01-31</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/01/31/AES%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/01/31/AES%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>加密<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public static String encryptData(String content) &#123;</span><br><span class="line">    if (StringUtils.isEmpty(content)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        SecretKeySpec key = new SecretKeySpec(THEDIGEST.clone(), &quot;AES&quot;);   // 生成密钥</span><br><span class="line">        Cipher cipher = Cipher.getInstance(&quot;AES/GCM/PKCS5Padding&quot;);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, key);</span><br><span class="line">        byte[] iv = cipher.getIV();</span><br><span class="line">        byte[] contentByte = content.getBytes(DEFAULTCODING);</span><br><span class="line">        byte[] encryptData = cipher.doFinal(contentByte);</span><br><span class="line">        byte[] message = new byte[12 + contentByte.length + 16];</span><br><span class="line">        System.arraycopy(iv, 0, message, 0, 12);</span><br><span class="line">        System.arraycopy(encryptData, 0, message, 12, encryptData.length);</span><br><span class="line">        return Base64.encodeBase64String(message);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception e) &#123;</span><br><span class="line">        log.info(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>解密</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * AES解密</span><br><span class="line"> *</span><br><span class="line"> * @param content</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public static String decryptData(String content) &#123;</span><br><span class="line">    if (StringUtils.isEmpty(content)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        SecretKeySpec key = new SecretKeySpec(THEDIGEST.clone(), &quot;AES&quot;);</span><br><span class="line">        byte[] contentByte = Base64.decodeBase64(content);</span><br><span class="line">        if (contentByte.length &lt; 12 + 16) &#123;</span><br><span class="line">            throw new IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        GCMParameterSpec params = new GCMParameterSpec(128, contentByte, 0, 12);</span><br><span class="line">        Cipher cipher1 = Cipher.getInstance(&quot;AES/GCM/PKCS5Padding&quot;);</span><br><span class="line">        cipher1.init(Cipher.DECRYPT_MODE, key, params);</span><br><span class="line">        byte[] decryptData = cipher1.doFinal(contentByte, 12, contentByte.length - 12);</span><br><span class="line"></span><br><span class="line">        return new String(decryptData, DEFAULTCODING);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception e) &#123;</span><br><span class="line">        log.info(e.getMessage(), e);</span><br><span class="line">        return content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/22/2024-01-22-ftp%E4%B8%8B%E8%BD%BD%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="夏远建">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="夏远建的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/01/22/2024-01-22-ftp%E4%B8%8B%E8%BD%BD%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">2024-01-22 ftp下载性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-01-22 10:07:52" itemprop="dateCreated datePublished" datetime="2024-01-22T10:07:52+08:00">2024-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-31 10:20:59" itemprop="dateModified" datetime="2024-01-31T10:20:59+08:00">2024-01-31</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/01/22/2024-01-22-ftp%E4%B8%8B%E8%BD%BD%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/01/22/2024-01-22-ftp%E4%B8%8B%E8%BD%BD%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>维保合同下载实现ftp下载功能。支持自定义配置。做完发现下载速度缓慢 30s 下载完成</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>以下为下载代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * 下载FTP下指定文件</span><br><span class="line"> * @param ftp FTPClient对象</span><br><span class="line"> * @param path FTP文件路径</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public static InputStream downLoadFTP(FTPClient ftp, String path) &#123;</span><br><span class="line">    InputStream in = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        ftp.setControlEncoding(&quot;UTF-8&quot;);</span><br><span class="line">        ftp.setFileType(FTP.BINARY_FILE_TYPE);</span><br><span class="line">        in = ftp.retrieveFileStream(path);</span><br><span class="line">        ftp.changeWorkingDirectory(&quot;/&quot;);</span><br><span class="line">    &#125; catch (Exception var5) &#123;</span><br><span class="line">        log.error(&quot;ftp下载文件失败&quot;, var5);</span><br><span class="line">    &#125;</span><br><span class="line">    return in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ol>
<li>in &#x3D; ftp.retrieveFileStream(path); 查看源码可以得出返回是个缓存流。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">protected InputStream _retrieveFileStream(String command, String remote) throws IOException &#123;</span><br><span class="line">    Socket socket = this._openDataConnection_(command, remote);</span><br><span class="line">    if (socket == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        Object input;</span><br><span class="line">        if (this.__fileType == 0) &#123;</span><br><span class="line">            input = new FromNetASCIIInputStream(this.getBufferedInputStream(socket.getInputStream()));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            input = socket.getInputStream();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return new SocketInputStream(socket, (InputStream)input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>ftp.changeWorkingDirectory(“&#x2F;“); 改变目录，跳转到根目录。 根目录有权限限制，查看日志发现这行代码抛错。</li>
</ol>
<h3 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h3><ol>
<li>增大缓存区域 ftp.setBufferSize(1024 * 1024 * 10);。</li>
<li>删除ftp.changeWorkingDirectory(“&#x2F;“)。</li>
</ol>
<h3 id="优化结果"><a href="#优化结果" class="headerlink" title="优化结果"></a>优化结果</h3><p>下载速度优化到 3 秒 以内</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">夏远建</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">夏远建</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">181k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:29</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'JM04yDYxfC7OBdEVFPgjYe82-gzGzoHsz',
      appKey     : 'N0ThHHvSUDiGsV5vHwy9wavK',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-CN' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
